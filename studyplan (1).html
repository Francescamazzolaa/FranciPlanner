<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FranciPlanner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PALETTE & TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  /* Superficie neutra â€” sfumature di bianco/grigio puro */
  --paper :#FFFFFF;
  --paper2:#F7F7F8;
  --paper3:#EFEFF1;
  --paper4:#E4E4E7;
  /* Testo */
  --ink  :#09090B;
  --ink2 :#52525B;
  --ink3 :#A1A1AA;
  /* Bordi */
  --line :#E4E4E7;
  --line2:#D4D4D8;
  /* Semantici â€” usati con parsimonia */
  --amber   :#B45309;--amber-bg:#FEF3C7;
  --red     :#DC2626;--red-bg  :#FEF2F2;
  --green   :#16A34A;--green-bg:#F0FDF4;
  --blue    :#2563EB;--blue-bg :#EFF6FF;
  /* Raggi â€” piÃ¹ generosi */
  --r :6px;
  --r2:10px;
  --r3:14px;
  /* Tipografia */
  --serif:Georgia,'Times New Roman',serif;
  --sans :'Inter',system-ui,-apple-system,sans-serif;
  --mono :'JetBrains Mono','Courier New',monospace;
  /* Ombre */
  --sh :0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.04);
  --sh2:0 4px 16px rgba(0,0,0,.08),0 1px 4px rgba(0,0,0,.04);
  --sh3:0 8px 32px rgba(0,0,0,.10),0 2px 8px rgba(0,0,0,.06);
  /* Layout */
  --sidebar:240px;--topbar:50px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DARK MODE â€” grigio neutro
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme=dark]{
  --paper :#09090B;
  --paper2:#111113;
  --paper3:#18181B;
  --paper4:#27272A;
  --ink  :#FAFAFA;
  --ink2 :#A1A1AA;
  --ink3 :#52525B;
  --line :#27272A;
  --line2:#3F3F46;
  --amber   :#F59E0B;--amber-bg:#1C1300;
  --red     :#EF4444;--red-bg  :#1A0505;
  --green   :#22C55E;--green-bg:#011A0A;
  --blue    :#60A5FA;--blue-bg :#030E23;
  --sh :0 1px 3px rgba(0,0,0,.4),0 1px 2px rgba(0,0,0,.3);
  --sh2:0 4px 16px rgba(0,0,0,.5),0 1px 4px rgba(0,0,0,.35);
  --sh3:0 8px 32px rgba(0,0,0,.6),0 2px 8px rgba(0,0,0,.4);
}
[data-theme=dark] body{color-scheme:dark;}
[data-theme=dark] .cal-cell.today{background:#1A1200;}
[data-theme=dark] .cal-cell.today:hover{background:#221800;}
[data-theme=dark] .t-arc{stroke:var(--ink);}
[data-theme=dark] .exam-cell{background:#1A1200;border-color:#78350F;}
[data-theme=dark] .exam-cell-label{color:#FDE68A;}
[data-theme=dark] .exam-cell-name{color:#FDE68A;}
[data-theme=dark] .exam-banner{background:#1A1200;border-color:#78350F;}
[data-theme=dark] .exam-banner-name{color:#FDE68A;}
[data-theme=dark] .podio-item.gold{background:#1A1200;border-color:#78350F;}
[data-theme=dark] .podio-item.silver{background:#18181B;border-color:#3F3F46;}
[data-theme=dark] .podio-item.bronze{background:#1A0D00;border-color:#5C2E00;}
[data-theme=dark] .nav-btn.active{background:var(--ink);color:var(--paper);}
[data-theme=dark] .brand-mark{background:transparent;}
[data-theme=dark] .brand-mark svg{stroke:var(--ink2);}
[data-theme=dark] .snooze-warn{background:var(--red-bg);border-color:var(--red);}
[data-theme=dark] input[type=color]{background:var(--paper3);}
[data-theme=dark] .sim-card.low{background:#011A0A;border-color:#166534;}
[data-theme=dark] .sim-card.medium{background:#1C1300;border-color:#854D0E;}
[data-theme=dark] .sim-card.high{background:#1A0505;border-color:#991B1B;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  font-family:var(--sans);
  background:var(--paper);
  color:var(--ink);
  font-size:14px;
  line-height:1.6;
  letter-spacing:-.01em;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{display:flex;height:100vh;overflow:hidden;}

.sidebar{
  width:var(--sidebar);
  background:var(--paper2);
  border-right:1px solid var(--line);
  display:flex;flex-direction:column;
  transition:width .25s cubic-bezier(.4,0,.2,1);
  overflow:hidden;flex-shrink:0;
}
.sidebar.closed{width:52px;overflow:hidden;}
/* Mini sidebar â€” solo icone, nessun testo visibile */
.sidebar.closed .sidebar-inner{padding:10px 0 12px;width:52px;overflow:hidden;}
.sidebar.closed .brand{padding:12px 0 16px;justify-content:center;gap:0;}
.sidebar.closed .brand-name{display:none;}
.sidebar.closed .brand-mark{margin:0 auto;}
.sidebar.closed .nav-btn{
  width:36px;height:36px;
  padding:0;margin:2px auto;
  border-radius:var(--r2);
  justify-content:center;
  overflow:hidden;
  /* impedisce al testo di uscire */
  white-space:nowrap;
}
.sidebar.closed .nav-btn .ni{
  font-size:16px;flex-shrink:0;width:auto;margin:0;opacity:1;
}
/* Nasconde tutto ciÃ² che non Ã¨ l'icona .ni */
.sidebar.closed .nav-btn .nav-lbl,
.sidebar.closed .nav-btn .badge-nav{
  display:none !important;
}
/* Nasconde anche i text node â€” li tagliamo con clip */
.sidebar.closed .sep{margin:4px 10px;}
/* Tooltip hover */
.sidebar.closed .nav-btn{position:relative;}
.sidebar.closed .nav-btn::after{
  content:attr(data-label);
  position:absolute;left:52px;top:50%;transform:translateY(-50%);
  background:var(--ink);color:var(--paper);
  font-size:12px;font-weight:500;
  padding:5px 11px;border-radius:var(--r);
  white-space:nowrap;pointer-events:none;
  opacity:0;transition:opacity .15s;
  z-index:300;box-shadow:var(--sh2);
}
.sidebar.closed .nav-btn:hover::after{opacity:1;}
.sidebar-inner{
  width:var(--sidebar);
  display:flex;flex-direction:column;
  height:100%;overflow-y:auto;
  padding:12px 0 20px;
}
.brand{padding:14px 16px 18px;display:flex;align-items:center;gap:10px;}
.brand-mark{
  width:28px;height:28px;
  background:transparent;
  border:none;
  border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
  cursor:pointer;
  padding:0;
  transition:opacity .15s;
}
.brand-mark:hover{opacity:.6;}
.brand-mark svg{stroke:var(--ink);width:18px;height:18px;}
.brand-name{font-family:var(--sans);font-size:14px;font-weight:600;color:var(--ink);}

.nav-btn{
  display:flex;align-items:center;gap:9px;
  padding:7px 11px;margin:1px 8px;
  border-radius:var(--r2);border:none;background:none;
  font-family:var(--sans);font-size:13px;font-weight:400;
  color:var(--ink2);cursor:pointer;
  transition:background .15s,color .15s;
  width:calc(100% - 16px);text-align:left;white-space:nowrap;
}
.nav-btn:hover{background:var(--paper3);color:var(--ink);}
.nav-btn.active{background:var(--ink);color:var(--paper);font-weight:500;}
.nav-btn .ni{font-size:14px;width:18px;text-align:center;flex-shrink:0;opacity:.75;}
.nav-btn.active .ni{opacity:1;}
.badge-nav{
  margin-left:auto;font-size:10px;
  background:var(--amber-bg);color:var(--amber);
  padding:1px 7px;border-radius:99px;font-weight:600;
}
.sep{height:1px;background:var(--line);margin:6px 14px;}

/* heart-toggle esterno rimosso: mini sidebar sempre visibile */

.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{
  height:var(--topbar);
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;
  padding:0 24px;
  background:var(--paper);
  flex-shrink:0;gap:10px;
}
.topbar-title{font-family:var(--sans);font-size:15px;font-weight:600;color:var(--ink);}
.topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
.page-wrap{flex:1;overflow-y:auto;padding:36px 56px 72px;}
.page-wrap > *{max-width:860px;}
@media(max-width:900px){.page-wrap{padding:24px 20px 56px;}}
@media(max-width:600px){.page-wrap{padding:18px 14px 48px;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page{display:none;}
.page.active{display:block;animation:pgIn .15s ease;}
@keyframes pgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.ph{font-family:var(--sans);font-size:24px;font-weight:700;letter-spacing:-.4px;margin-bottom:4px;line-height:1.2;}
.ps{font-size:13px;color:var(--ink3);margin-bottom:30px;line-height:1.6;}
.sec{
  font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:.9px;
  color:var(--ink3);margin-bottom:10px;
}
hr{border:none;border-top:1px solid var(--line);margin:28px 0;}
.empty{font-size:13.5px;color:var(--ink3);padding:16px 0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STRIP / KPI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strip{
  display:flex;
  border:1px solid var(--line);
  border-radius:var(--r2);
  overflow:hidden;
  margin-bottom:28px;
  box-shadow:var(--sh);
  background:var(--paper);
}
.strip-cell{flex:1;padding:16px 20px;border-right:1px solid var(--line);}
.strip-cell:last-child{border-right:none;}
.strip-val{font-family:var(--sans);font-size:26px;font-weight:700;letter-spacing:-.4px;line-height:1.1;}
.strip-lbl{font-size:11px;color:var(--ink3);margin-top:3px;font-weight:500;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;gap:5px;
  padding:7px 14px;
  border-radius:var(--r);
  border:1px solid var(--line2);
  font-family:var(--sans);font-size:13px;font-weight:500;
  cursor:pointer;
  transition:all .15s;
  background:var(--paper);color:var(--ink);
  white-space:nowrap;
  box-shadow:var(--sh);
}
.btn:hover{background:var(--paper3);border-color:var(--line2);}
.btn:active{transform:scale(.98);}
.btn-primary{
  background:var(--ink);color:var(--paper);
  border-color:var(--ink);
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
.btn-primary:hover{background:#18181B;border-color:#18181B;}
.btn-ghost{border-color:transparent;background:transparent;color:var(--ink2);box-shadow:none;}
.btn-ghost:hover{background:var(--paper3);color:var(--ink);}
.btn-danger{color:var(--red);border-color:#fca5a5;background:var(--red-bg);box-shadow:none;}
.btn-danger:hover{background:#fee2e2;}
.btn-sm{padding:4px 10px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;}
.btn-icon{padding:5px 8px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field{margin-bottom:16px;}
.flbl{font-size:12px;font-weight:600;color:var(--ink2);margin-bottom:5px;letter-spacing:.1px;}
.inp{
  width:100%;padding:8px 11px;
  font-family:var(--sans);font-size:13.5px;
  color:var(--ink);background:var(--paper);
  border:1px solid var(--line2);
  border-radius:var(--r);outline:none;
  transition:border-color .15s,box-shadow .15s;
}
.inp:focus{border-color:var(--ink);box-shadow:0 0 0 3px rgba(9,9,11,.08);}
.inp::placeholder{color:var(--ink3);}
select.inp{cursor:pointer;}
input[type=color].inp{padding:3px 6px;height:36px;cursor:pointer;}
input[type=range].inp{padding:0;border:none;background:none;cursor:pointer;accent-color:var(--ink);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge{display:inline-block;padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600;letter-spacing:.1px;}
.b-def{background:var(--paper3);color:var(--ink2);}
.b-amber{background:var(--amber-bg);color:var(--amber);}
.b-red{background:var(--red-bg);color:var(--red);}
.b-green{background:var(--green-bg);color:var(--green);}
.b-blue{background:var(--blue-bg);color:var(--blue);}
.mem-instabile{background:var(--red-bg);color:var(--red);}
.mem-consolidamento{background:var(--amber-bg);color:var(--amber);}
.mem-consolidato{background:var(--green-bg);color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS / DOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog{height:4px;background:var(--paper3);border-radius:99px;overflow:hidden;}
.prog-bar{height:100%;border-radius:99px;transition:width .5s ease;}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROW LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.row{
  display:flex;align-items:flex-start;gap:11px;
  padding:10px 0;
  border-bottom:1px solid var(--line);
  transition:background .12s;
}
.row:last-child{border-bottom:none;}
.row-act{display:flex;gap:3px;margin-left:auto;opacity:0;transition:opacity .15s;flex-shrink:0;}
.row:hover .row-act{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
  border:1px solid var(--line);
  border-radius:var(--r2);
  padding:18px 20px;
  background:var(--paper);
  box-shadow:var(--sh);
}
.card+.card{margin-top:12px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.subj-card{
  border:1px solid var(--line);
  border-radius:var(--r2);
  margin-bottom:10px;
  overflow:hidden;
  background:var(--paper);
  box-shadow:var(--sh);
  transition:box-shadow .2s;
}
.subj-card:hover{box-shadow:var(--sh2);}
.subj-head{
  display:flex;align-items:center;gap:11px;
  padding:13px 16px;
  cursor:pointer;
  transition:background .12s;
}
.subj-head:hover{background:var(--paper2);}
.subj-body{border-top:1px solid var(--line);padding:6px 16px 16px;}
.chev{font-size:9px;color:var(--ink3);transition:transform .18s;flex-shrink:0;}
.chev.open{transform:rotate(90deg);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPIC TREE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tree-row{
  display:flex;align-items:flex-start;gap:8px;
  padding:8px 0;
  border-bottom:1px solid var(--line);
  transition:background .12s;
}
.tree-row:last-child{border-bottom:none;}
.tree-act{display:flex;gap:3px;margin-left:auto;opacity:0;transition:opacity .15s;flex-shrink:0;}
.tree-row:hover .tree-act{opacity:1;}
.tree-exp{width:13px;font-size:8px;color:var(--ink3);cursor:pointer;flex-shrink:0;text-align:center;padding-top:3px;}
.tree-lbl{font-size:13.5px;flex:1;min-width:0;}
.tree-lbl.d1{font-size:13px;color:var(--ink2);}
.tree-lbl.d2{font-size:12.5px;color:var(--ink3);}
.tree-meta{font-size:11px;color:var(--ink3);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.load-bar{display:flex;gap:3px;align-items:flex-end;height:56px;}
.load-seg{flex:1;border-radius:4px 4px 0 0;min-height:3px;cursor:pointer;transition:opacity .15s;}
.load-seg:hover{opacity:.7;}
.load-labels{display:flex;gap:3px;margin-top:4px;}
.load-lbl{flex:1;text-align:center;font-size:10px;color:var(--ink3);font-family:var(--mono);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cal-header{display:flex;align-items:center;gap:8px;margin-bottom:22px;flex-wrap:wrap;}
.cal-tabs{
  display:flex;gap:2px;
  background:var(--paper3);
  border-radius:var(--r);
  padding:3px;
}
.cal-tab{
  padding:5px 13px;font-size:12px;font-weight:500;
  cursor:pointer;border-radius:var(--r);
  color:var(--ink2);border:none;background:none;
  transition:all .15s;font-family:var(--sans);
}
.cal-tab.active{
  background:var(--paper);color:var(--ink);
  box-shadow:var(--sh);
}
.cal-nav{display:flex;align-items:center;gap:8px;margin-left:auto;}
.cal-nav-title{font-size:13.5px;font-weight:600;min-width:160px;text-align:center;}
.cal-grid{border:1px solid var(--line);border-radius:var(--r2);overflow:hidden;box-shadow:var(--sh);}
.cal-col-hdrs{display:grid;border-bottom:1px solid var(--line);}
.cal-col-h{
  padding:8px 0;text-align:center;
  font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:.7px;
  color:var(--ink3);background:var(--paper2);
}
.cal-cells{display:grid;}
.cal-cell{
  min-height:96px;padding:8px 8px 6px;
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  background:var(--paper);
  transition:background .12s;
  cursor:pointer;
}
.cal-cell:hover{background:var(--paper2);}
.cal-cell:nth-child(7n){border-right:none;}
.cal-cell.today{background:#FAFAFA;border-top:2px solid var(--ink);}
.cal-cell.today:hover{background:var(--paper2);}
.cal-cell.other-m{background:var(--paper2);cursor:default;opacity:.65;}
.cal-date-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.cal-dn{font-size:11.5px;font-weight:500;color:var(--ink3);}
.cal-dn.today{
  color:var(--paper);background:var(--ink);
  width:20px;height:20px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:10.5px;font-weight:700;
}
.cal-load-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.cal-summary{display:flex;flex-direction:column;gap:4px;}
.cal-summary-dots{display:flex;gap:3px;flex-wrap:wrap;align-items:center;}
.cal-summary-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.cal-summary-label{font-size:9.5px;color:var(--ink3);line-height:1.4;margin-top:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASSIFICA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wk-compare-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.wk-bar-wrap{flex:1;height:5px;background:var(--paper3);border-radius:99px;overflow:hidden;}
.wk-bar{height:100%;border-radius:99px;transition:width .5s;}
.wk-label{font-size:11px;color:var(--ink3);min-width:52px;text-align:right;font-family:var(--mono);}
.wk-name{font-size:12px;min-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.podio-item{
  display:flex;align-items:center;gap:14px;
  padding:14px 16px;border-radius:var(--r2);
  margin-bottom:10px;
  border:1px solid var(--line);
  background:var(--paper);
  box-shadow:var(--sh);
  transition:box-shadow .2s;
}
.podio-item:hover{box-shadow:var(--sh2);}
.podio-item.gold{border-color:#D97706;background:#FEFCE8;}
.podio-item.silver{border-color:#9CA3AF;background:#F9FAFB;}
.podio-item.bronze{border-color:#92400E;background:#FFF7ED;}
.podio-rank{font-size:24px;line-height:1;flex-shrink:0;}
.podio-body{flex:1;min-width:0;}
.podio-ore{font-family:var(--mono);font-size:16px;font-weight:700;color:var(--ink);}
.podio-date{font-size:11px;color:var(--ink3);margin-top:2px;}
.podio-badge{font-size:11px;padding:3px 9px;border-radius:99px;background:var(--green);color:#fff;white-space:nowrap;}
.wk-log-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--line);}
.wk-log-row:last-child{border-bottom:none;}
.wk-delta{font-size:11px;min-width:52px;text-align:right;font-family:var(--mono);}
.wk-motiv-banner{display:flex;align-items:center;gap:10px;}
.wk-motiv-icon{font-size:20px;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESAMI IN CALENDARIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exam-cell{
  background:#FEFCE8;border:1px solid #CA8A04;
  border-radius:5px;padding:3px 7px;margin-bottom:3px;
  display:flex;align-items:center;gap:5px;overflow:hidden;
}
.exam-cell-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#92400E;flex-shrink:0;}
.exam-cell-name{font-size:9.5px;font-weight:600;color:#78350F;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.exam-banner{
  display:flex;align-items:center;gap:12px;
  padding:14px 16px;border-radius:var(--r2);
  border:1px solid #D97706;background:#FEFCE8;
  margin-bottom:18px;box-shadow:var(--sh);
}
.exam-banner-icon{font-size:22px;flex-shrink:0;}
.exam-banner-body{flex:1;min-width:0;}
.exam-banner-name{font-size:14.5px;font-weight:600;color:#78350F;}
.exam-banner-meta{font-size:12px;color:#92400E;margin-top:2px;}
.snooze-btn{
  margin-top:7px;font-size:11.5px;
  color:var(--ink3);background:none;
  border:1px solid var(--line);
  border-radius:var(--r);padding:4px 12px;
  cursor:pointer;font-family:var(--sans);
  transition:all .15s;
}
.snooze-btn:hover{background:var(--paper3);color:var(--ink);}
.snooze-warn{
  font-size:11.5px;color:var(--red);
  padding:8px 12px;border-radius:var(--r);
  background:var(--red-bg);border:1px solid #fca5a5;
  margin-top:10px;
}
.cal-entry{margin-bottom:3px;border-radius:4px;overflow:hidden;border-left:2px solid transparent;}
.cal-entry-s{font-size:10px;font-weight:600;padding:2px 5px 1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cal-entry-t{font-size:9.5px;padding:0 5px 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:.8;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAY VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.day-view{border:1px solid var(--line);border-radius:var(--r2);overflow:hidden;display:grid;box-shadow:var(--sh);}
.day-col-h{
  padding:11px 16px 10px;
  border-bottom:1px solid var(--line);
  background:var(--paper2);
  border-right:1px solid var(--line);
}
.day-col-h:last-child{border-right:none;}
.day-col-dl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink3);margin-bottom:2px;}
.day-col-dn{font-family:var(--sans);font-size:22px;font-weight:700;color:var(--ink);line-height:1.1;}
.day-col-dn.today{color:var(--ink);}
.day-col-body{padding:14px 16px;min-height:180px;border-right:1px solid var(--line);}
.day-col-body:last-child{border-right:none;}
.scard{border:1px solid var(--line);border-radius:var(--r);margin-bottom:10px;overflow:hidden;background:var(--paper);}
.scard-h{padding:7px 11px 6px;display:flex;align-items:center;gap:8px;}
.scard-s{font-size:11px;font-weight:600;flex:1;}
.scard-meta{font-size:10px;color:var(--ink3);}
.scard-body{padding:0 11px 9px;}
.scard-row{display:flex;align-items:flex-start;gap:5px;padding:4px 0;border-top:1px solid var(--line);font-size:12px;line-height:1.55;}
.scard-ind{color:var(--ink3);font-size:9px;padding-top:3px;flex-shrink:0;font-family:var(--mono);width:16px;}
.scard-tl{flex:1;min-width:0;}
.scard-tl.l0{color:var(--ink);font-weight:500;}
.scard-tl.l1{color:var(--ink2);}
.scard-tl.l2{color:var(--ink3);font-size:11.5px;}
.scard-done .scard-tl{opacity:.4;text-decoration:line-through;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAY POPUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dpop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.25);
  z-index:150;display:none;
  align-items:flex-start;justify-content:center;
  padding-top:60px;
  backdrop-filter:blur(2px);
}
.dpop.open{display:flex;}
.dpop-box{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--r3);
  width:560px;max-width:96vw;max-height:82vh;
  display:flex;flex-direction:column;
  box-shadow:var(--sh3);
  animation:mIn .16s ease;
}
.dpop-h{
  padding:18px 20px 14px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.dpop-t{font-family:var(--sans);font-size:16px;font-weight:600;}
.dpop-body{padding:18px 20px;overflow-y:auto;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-mode-tabs{
  display:flex;gap:3px;
  background:var(--paper3);border-radius:var(--r);
  padding:3px;margin-bottom:24px;
}
.timer-mode-tab{
  flex:1;padding:7px 0;text-align:center;
  font-size:12.5px;font-weight:500;
  cursor:pointer;border-radius:var(--r);
  color:var(--ink2);border:none;background:none;
  transition:all .15s;font-family:var(--sans);
}
.timer-mode-tab.active{background:var(--paper);color:var(--ink);box-shadow:var(--sh);}
.timer-cfg{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-bottom:22px;}
.timer-cfg-field{display:flex;flex-direction:column;align-items:center;gap:5px;min-width:76px;}
.timer-cfg-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink3);}
.timer-cfg-val{font-family:var(--mono);font-size:26px;font-weight:700;color:var(--ink);line-height:1;}
.timer-cfg-btns{display:flex;gap:4px;}
.timer-cfg-btn{
  width:26px;height:26px;
  border:1px solid var(--line2);border-radius:var(--r);
  background:var(--paper2);cursor:pointer;
  font-size:14px;font-weight:600;
  color:var(--ink2);
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.timer-cfg-btn:hover{background:var(--paper3);color:var(--ink);}
.timer-sess-info{display:flex;gap:8px;justify-content:center;margin-bottom:20px;flex-wrap:wrap;}
.timer-sess-badge{
  width:28px;height:28px;border-radius:50%;
  background:var(--paper3);
  font-size:12px;font-weight:600;color:var(--ink3);
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.timer-sess-badge.active{background:var(--ink);color:var(--paper);}
.timer-free-disp{
  font-family:var(--mono);font-size:56px;font-weight:700;
  letter-spacing:-3px;color:var(--ink);
  margin:28px 0;
}
.timer-preset-wrap{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;}
.timer-preset-btn{
  padding:6px 14px;border-radius:99px;
  border:1px solid var(--line2);
  background:var(--paper2);font-size:12px;
  cursor:pointer;color:var(--ink2);
  font-family:var(--sans);transition:all .15s;
  line-height:1.3;text-align:center;
}
.timer-preset-btn:hover{background:var(--paper3);color:var(--ink);}
.timer-preset-btn.active{background:var(--ink);color:var(--paper);border-color:var(--ink);}
.timer-wrap{max-width:380px;margin:0 auto;text-align:center;padding-top:20px;}
.timer-sn{
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:.7px;
  color:var(--ink3);margin-bottom:5px;
}
.timer-tn{font-family:var(--sans);font-size:19px;font-weight:600;margin-bottom:36px;}
.timer-ring{position:relative;width:190px;height:190px;margin:0 auto 32px;}
.timer-ring svg{transform:rotate(-90deg);}
.t-track{fill:none;stroke:var(--paper3);stroke-width:4;}
.t-arc{
  fill:none;stroke:var(--ink);stroke-width:4;
  stroke-linecap:round;
  transition:stroke-dashoffset 1s linear,stroke .3s;
}
.timer-disp{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  font-family:var(--mono);font-size:38px;
  letter-spacing:-2px;color:var(--ink);
  font-weight:700;
}
.timer-btns{display:flex;gap:10px;justify-content:center;margin-bottom:32px;}
.diff-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:5px;margin:12px 0 10px;}
.diff-btn{
  aspect-ratio:1;
  border:1px solid var(--line2);border-radius:var(--r);
  background:var(--paper);font-size:13px;font-weight:700;
  cursor:pointer;color:var(--ink2);
  transition:all .15s;font-family:var(--sans);
  display:flex;align-items:center;justify-content:center;
}
.diff-btn:hover{transform:scale(1.08);border-color:var(--ink);color:var(--ink);}
.diff-btn.sel{color:#fff !important;border-color:transparent;transform:scale(1.08);}
.plan-preview{
  margin-top:12px;margin-bottom:20px;
  padding:12px 14px;border-radius:var(--r2);
  background:var(--paper2);border:1px solid var(--line);
  font-size:12.5px;color:var(--ink2);
  line-height:1.7;min-height:40px;
}
.plan-preview strong{color:var(--ink);}
.plan-date-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.plan-date-chip{
  padding:3px 9px;border-radius:99px;
  font-size:11px;font-weight:600;font-family:var(--mono);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.h-hero{padding:36px 0 28px;margin-bottom:28px;}
.h-greet{font-family:var(--sans);font-size:32px;font-weight:700;letter-spacing:-.5px;color:var(--ink);margin-bottom:5px;line-height:1.2;}
.h-date{font-size:13.5px;color:var(--ink3);font-variant-numeric:tabular-nums;}
.h-time{font-family:var(--mono);font-size:13px;color:var(--ink3);margin-left:8px;opacity:.8;}
.h-kpi-row{display:flex;gap:10px;margin-bottom:26px;flex-wrap:wrap;}
.h-kpi{
  flex:1;min-width:100px;
  padding:16px 18px;
  border-radius:var(--r2);
  border:1px solid var(--line);
  background:var(--paper2);
  transition:box-shadow .2s;
}
.h-kpi:hover{box-shadow:var(--sh2);}
.h-kpi-val{font-family:var(--sans);font-size:24px;font-weight:700;letter-spacing:-.3px;color:var(--ink);line-height:1;}
.h-kpi-lbl{font-size:11px;color:var(--ink3);margin-top:4px;font-weight:500;}
.h-block{
  border:1px solid var(--line);
  border-radius:var(--r2);
  overflow:hidden;margin-bottom:12px;
  background:var(--paper);
  box-shadow:var(--sh);
  transition:box-shadow .2s;
}
.h-block:hover{box-shadow:var(--sh2);}
.h-block-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 16px;cursor:pointer;user-select:none;
  transition:background .12s;
}
.h-block-head:hover{background:var(--paper2);}
.h-block-title{display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;color:var(--ink);}
.h-block-icon{font-size:16px;width:24px;text-align:center;flex-shrink:0;}
.h-block-meta{font-size:12px;color:var(--ink3);font-weight:400;}
.h-block-chev{font-size:9px;color:var(--ink3);transition:transform .2s;}
.h-block-chev.open{transform:rotate(90deg);}
.h-block-body{border-top:1px solid var(--line);}
.h-item{
  display:flex;align-items:flex-start;gap:11px;
  padding:11px 16px;border-bottom:1px solid var(--line);
  cursor:pointer;transition:background .12s;
}
.h-item:last-child{border-bottom:none;}
.h-item:hover{background:var(--paper2);}
.h-item-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.h-item-main{flex:1;min-width:0;}
.h-item-title{font-size:13.5px;color:var(--ink);line-height:1.45;}
.h-item-sub{font-size:11.5px;color:var(--ink3);margin-top:2px;display:flex;align-items:center;gap:6px;}
.h-item-act{display:flex;gap:5px;align-items:center;flex-shrink:0;opacity:0;transition:opacity .15s;}
.h-item:hover .h-item-act{opacity:1;}
.h-item-expand{
  padding:10px 16px 14px 40px;
  border-bottom:1px solid var(--line);
  background:var(--paper2);
}
.h-item-expand:last-child{border-bottom:none;}
.h-exam-row{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;border-bottom:1px solid var(--line);
  cursor:pointer;transition:background .12s;
}
.h-exam-row:last-child{border-bottom:none;}
.h-exam-row:hover{background:var(--paper2);}
.h-exam-rank{font-family:var(--mono);font-size:11px;color:var(--ink3);width:20px;flex-shrink:0;text-align:right;}
.h-exam-color{width:3px;height:36px;border-radius:99px;flex-shrink:0;}
.h-exam-body{flex:1;min-width:0;}
.h-exam-name{font-size:13.5px;font-weight:500;color:var(--ink);}
.h-exam-date{font-size:11.5px;color:var(--ink3);margin-top:2px;}
.h-exam-chev{font-size:9px;color:var(--ink3);transition:transform .2s;}
.h-exam-chev.open{transform:rotate(90deg);}
.h-exam-detail{
  padding:14px 16px 16px 52px;
  border-bottom:1px solid var(--line);
  background:var(--paper2);
}
.h-exam-detail:last-child{border-bottom:none;}
.h-goal-bar{height:5px;background:var(--paper3);border-radius:99px;overflow:hidden;margin-top:7px;}
.h-goal-fill{height:100%;border-radius:99px;transition:width .6s;}
.h-week-msg{padding:11px 16px;font-size:12.5px;display:flex;align-items:center;gap:9px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIMULATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sim-card{border-radius:var(--r2);padding:20px 22px;margin-bottom:14px;border:1px solid var(--line);}
.sim-card.low{background:var(--green-bg);border-color:#86efac;}
.sim-card.medium{background:var(--amber-bg);border-color:#fcd34d;}
.sim-card.high{background:var(--red-bg);border-color:#fca5a5;}
.sim-risk-title{font-family:var(--sans);font-size:17px;font-weight:600;margin-bottom:6px;}
.risk-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--line);}
.risk-row:last-child{border-bottom:none;}
.risk-bar{flex:1;height:4px;background:var(--paper3);border-radius:99px;overflow:hidden;}
.risk-fill{height:100%;border-radius:99px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap{display:flex;align-items:flex-end;gap:3px;height:72px;}
.chart-bar{flex:1;border-radius:4px 4px 0 0;min-height:3px;transition:height .3s;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY / MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ov{
  position:fixed;inset:0;
  background:rgba(0,0,0,.3);
  z-index:100;display:none;
  align-items:flex-start;justify-content:center;
  padding-top:72px;
  backdrop-filter:blur(3px);
}
.ov.open{display:flex;}
.modal{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--r3);
  padding:24px 26px;
  width:480px;max-width:95vw;
  box-shadow:var(--sh3);
  animation:mIn .16s ease;
}
@keyframes mIn{from{transform:translateY(-8px);opacity:0}to{transform:none;opacity:1}}
.modal-title{font-family:var(--sans);font-size:17px;font-weight:600;margin-bottom:20px;}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:var(--ink);color:var(--paper);
  padding:10px 18px;border-radius:99px;
  font-size:13px;font-weight:500;
  box-shadow:var(--sh3);
  opacity:0;pointer-events:none;
  transition:opacity .2s;
  white-space:nowrap;z-index:200;
}
.toast.show{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--line2);border-radius:99px;}
::-webkit-scrollbar-thumb:hover{background:var(--ink3);}

/* Transizioni pagina fluide */
.page.active{animation:pgIn .18s cubic-bezier(.22,.68,0,1.1);}
@keyframes pgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* Focus ring accessibile */
:focus-visible{outline:2px solid var(--ink);outline-offset:2px;border-radius:var(--r);}

/* Timer config summary */
#cfgSummary{
  font-size:12px;color:var(--ink3);
  padding:8px 0;
  border-top:1px solid var(--line);
  margin-top:6px;
}

/* Studia list buttons show on hover */
.studia-row .row-act{opacity:0;transition:opacity .15s;}
.studia-row:hover .row-act{opacity:1;}

/* Chip date piano ripasso */
.plan-date-chip{
  padding:3px 10px;border-radius:99px;
  font-size:11px;font-weight:600;
  font-family:var(--mono);
}

/* Badge nav pulse quando ci sono sessioni */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.badge-nav{animation:pulse 2.5s ease-in-out infinite;}

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
.cf{
  position:fixed;inset:0;
  background:rgba(0,0,0,.3);
  z-index:500;
  display:none;
  align-items:center;justify-content:center;
  backdrop-filter:blur(3px);
}
.cf.open{display:flex;}
.cf-box{
  background:var(--paper);
  border:1px solid var(--line);
  border-radius:var(--r3);
  padding:26px 28px;
  width:420px;max-width:92vw;
  box-shadow:var(--sh3);
  animation:mIn .16s ease;
}
.cf-title{
  font-family:var(--sans);
  font-size:17px;font-weight:600;
  color:var(--ink);
  margin-bottom:10px;
}
.cf-body{
  font-size:13.5px;color:var(--ink2);
  line-height:1.6;margin-bottom:22px;
}
.cf-btns{display:flex;justify-content:flex-end;gap:10px;}
</style>
</head>
<body>
<div class="app">

<aside class="sidebar" id="sidebar">
  <div class="sidebar-inner">
    <div class="brand">
      <button class="brand-mark" onclick="UI.toggleSidebar()" title="Chiudi menu" aria-label="Toggle sidebar"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M8 13.5C8 13.5 2 9.8 2 5.8a3.2 3.2 0 0 1 6-1.5 3.2 3.2 0 0 1 6 1.5C14 9.8 8 13.5 8 13.5Z"/></svg></button>
      <span class="brand-name">FranciPlanner</span>
    </div>
    <button class="nav-btn active" id="nav-home"        data-label="Dashboard" onclick="UI.goto('home')"><span class="ni">âŒ‚</span><span class="nav-lbl">Dashboard</span></button>
    <button class="nav-btn"        id="nav-materie"     data-label="Materie" onclick="UI.goto('materie')"><span class="ni">â—ˆ</span><span class="nav-lbl">Materie</span></button>
    <button class="nav-btn"        id="nav-studia"      data-label="Studia" onclick="UI.goto('studia')"><span class="ni">â—·</span><span class="nav-lbl">Studia</span><span class="badge-nav" id="badgeStudia" style="display:none">0</span></button>
    <button class="nav-btn"        id="nav-calendario"  data-label="Calendario" onclick="UI.goto('calendario')"><span class="ni">â–¦</span><span class="nav-lbl">Calendario</span></button>
    <button class="nav-btn"        id="nav-simulazione" data-label="Simulazione" onclick="UI.goto('simulazione')"><span class="ni">â—¬</span><span class="nav-lbl">Simulazione</span></button>
    <button class="nav-btn"        id="nav-statistiche" data-label="Statistiche" onclick="UI.goto('statistiche')"><span class="ni">â—«</span><span class="nav-lbl">Statistiche</span></button>
    <button class="nav-btn"        id="nav-classifica"  data-label="Classifica" onclick="UI.goto('classifica')"><span class="ni">â‹®</span><span class="nav-lbl">Classifica</span></button>
    <div class="sep"></div>
    <button class="nav-btn" id="nav-impostazioni" data-label="Impostazioni" onclick="UI.goto('impostazioni')"><span class="ni">âš™</span><span class="nav-lbl">Impostazioni</span></button>
    <button class="nav-btn" style="color:var(--red)" onclick="UI.confirmReset()"><span class="ni">â†º</span><span class="nav-lbl">Reset dati</span></button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topTitle">Dashboard</div>
    <div class="topbar-right" id="topRight"></div>
  </div>
  <div class="page-wrap">

    <!-- HOME -->
    <div class="page active" id="page-home">

      <!-- â‘  Hero: saluto + ora â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="h-hero">
        <div class="h-greet" id="hGreet">Buongiorno</div>
        <div class="h-date" id="hDate">
          <span id="hDateTxt"></span>
          <span class="h-time" id="hTimeTxt"></span>
        </div>
      </div>

      <!-- â‘¡ KPI row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="h-kpi-row">
        <div class="h-kpi">
          <div class="h-kpi-val" id="hKpiOre">â€”</div>
          <div class="h-kpi-lbl">Ore oggi</div>
        </div>
        <div class="h-kpi">
          <div class="h-kpi-val" id="hKpiRev">0</div>
          <div class="h-kpi-lbl">Ripassi oggi</div>
        </div>
        <div class="h-kpi">
          <div class="h-kpi-val" id="hKpiInst">0</div>
          <div class="h-kpi-lbl">Instabili</div>
        </div>
        <div class="h-kpi" id="hKpiExamWrap" style="cursor:pointer;" onclick="UI.toggleBlock('hExamsBlock','hExamsChev')">
          <div class="h-kpi-val" id="hKpiExams">0</div>
          <div class="h-kpi-lbl">Esami da sostenere</div>
        </div>
      </div>

      <!-- Obiettivo settimanale (compatto) -->
      <div style="margin-bottom:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);">Obiettivo settimanale</span>
          <span id="hOreWGoal" style="font-size:11px;color:var(--ink3);font-family:var(--mono);">â€”</span>
        </div>
        <div class="h-goal-bar">
          <div id="hOreWBar" class="h-goal-fill" style="width:0%;background:var(--green);"></div>
        </div>
      </div>

      <!-- â‘¢ Argomenti da studiare oggi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="h-block" id="hStudyBlock">
        <div class="h-block-head" onclick="UI.toggleBlock('hStudyBody','hStudyChev')">
          <div class="h-block-title">
            <span class="h-block-icon">ğŸ“–</span>
            <span>Argomenti da studiare oggi</span>
            <span class="h-block-meta" id="hStudyMeta"></span>
          </div>
          <span class="h-block-chev open" id="hStudyChev">â–¶</span>
        </div>
        <div class="h-block-body" id="hStudyBody"></div>
      </div>

      <!-- â‘£ Ripassi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="h-block" id="hRevBlock">
        <div class="h-block-head" onclick="UI.toggleBlock('hRevBody','hRevChev')">
          <div class="h-block-title">
            <span class="h-block-icon">ğŸ”</span>
            <span>Ripassi di oggi</span>
            <span class="h-block-meta" id="hRevMeta"></span>
          </div>
          <span class="h-block-chev open" id="hRevChev">â–¶</span>
        </div>
        <div class="h-block-body" id="hRevBody"></div>
      </div>

      <!-- â‘¤ Esami â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="h-block" id="hExamsBlock">
        <div class="h-block-head" onclick="UI.toggleBlock('hExamsBody','hExamsChev')">
          <div class="h-block-title">
            <span class="h-block-icon">ğŸ“</span>
            <span>Esami da sostenere</span>
            <span class="h-block-meta" id="hExamsMeta"></span>
          </div>
          <span class="h-block-chev" id="hExamsChev">â–¶</span>
        </div>
        <div class="h-block-body" id="hExamsBody" style="display:none;"></div>
      </div>

      <!-- â‘¥ Carico settimana (compatto) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div style="margin-top:20px;">
        <div class="sec" style="margin-bottom:8px;">CARICO â€” PROSSIMI 7 GIORNI</div>
        <div class="load-bar" id="loadChart"></div>
        <div class="load-labels" id="loadLabels"></div>
      </div>

      <!-- hidden ids per compatibilitÃ  con vecchio codice -->
      <span id="hNDays" style="display:none"></span>
      <span id="hNName" style="display:none"></span>
      <span id="hOggi" style="display:none"></span>
      <span id="hInst" style="display:none"></span>
      <span id="hCarico" style="display:none"></span>
      <span id="hOreOggi" style="display:none"></span>
      <div id="hWkWidget" style="display:none"></div>
      <div id="hExamAlerts" style="display:none"></div>
      <div id="hToday" style="display:none"></div>
      <div id="hPriority" style="display:none"></div>

    </div>

    <!-- MATERIE -->
    <div class="page" id="page-materie">
      <div class="ph">Materie</div>
      <div class="ps">Materia â†’ Argomento â†’ Sotto-argomento â†’ Micro-argomento</div>
      <div id="materieList"></div>
      <div class="empty" id="materieEmpty">Nessuna materia. Aggiungine una dal pulsante in alto.</div>
    </div>

    <!-- STUDIA -->
    <div class="page" id="page-studia">
      <div id="studiaSelect">
        <div class="ph">Studia</div>
        <div class="ps">Ordinati per prioritÃ  dinamica. Il colore â˜… indica la difficoltÃ .</div>
        <div id="studiaList"></div>
        <div class="empty" id="studiaEmpty" style="display:none">Aggiungi argomenti dalla sezione Materie.</div>
      </div>
      <div id="studiaTimer" style="display:none">

        <!-- â”€â”€â”€ FASE 1: CONFIGURAZIONE â”€â”€â”€ -->
        <div id="timerConfig">
          <div class="timer-wrap" style="max-width:420px;">
            <div class="timer-sn" id="tSubj"></div>
            <div class="timer-tn" id="tTopic"></div>

            <!-- Tabs modalitÃ  -->
            <div class="timer-mode-tabs">
              <button class="timer-mode-tab active" id="tabCountdown" onclick="UI.setTimerMode('countdown',this)">â± Countdown</button>
              <button class="timer-mode-tab" id="tabFree" onclick="UI.setTimerMode('free',this)">âˆ Timer Libero</button>
            </div>

            <!-- COUNTDOWN: preset + config -->
            <div id="timerCountdownArea">
              <div class="timer-preset-wrap" id="timerPresets"></div>
              <div class="timer-cfg">
                <div class="timer-cfg-field">
                  <div class="timer-cfg-lbl">Studio (min)</div>
                  <div class="timer-cfg-val" id="cfgStudy">25</div>
                  <div class="timer-cfg-btns">
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('study',-5)">âˆ’</button>
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('study',5)">+</button>
                  </div>
                </div>
                <div class="timer-cfg-field">
                  <div class="timer-cfg-lbl">Pausa (min)</div>
                  <div class="timer-cfg-val" id="cfgBreak">5</div>
                  <div class="timer-cfg-btns">
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('break',-5)">âˆ’</button>
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('break',5)">+</button>
                  </div>
                </div>
                <div class="timer-cfg-field">
                  <div class="timer-cfg-lbl">Sessioni</div>
                  <div class="timer-cfg-val" id="cfgSessions">1</div>
                  <div class="timer-cfg-btns">
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('sessions',-1)">âˆ’</button>
                    <button class="timer-cfg-btn" onclick="UI.adjCfg('sessions',1)">+</button>
                  </div>
                </div>
              </div>
              <div style="font-size:11.5px;color:var(--ink3);margin-bottom:16px;" id="cfgSummary"></div>
            </div>

            <!-- FREE MODE config -->
            <div id="timerFreeArea" style="display:none;">
              <div style="font-size:13px;color:var(--ink3);margin:20px 0 28px;line-height:1.7;">
                Il timer conta in avanti da <strong>00:00</strong>.<br>
                Premi <strong>Fine sessione</strong> quando hai terminato.
              </div>
            </div>

            <!-- Pulsanti azione config -->
            <div class="timer-btns">
              <button class="btn btn-ghost" onclick="UI.timerAbort()">â† Annulla</button>
              <button class="btn btn-primary" style="flex:1;justify-content:center;" onclick="UI.timerStart()">â–¶ Avvia</button>
            </div>
          </div>
        </div>

        <!-- â”€â”€â”€ FASE 2: TIMER IN ESECUZIONE â”€â”€â”€ -->
        <div id="timerRunning" style="display:none;">
          <div class="timer-wrap" style="max-width:420px;">
            <div class="timer-sn" id="tSubjR"></div>
            <div class="timer-tn" id="tTopicR"></div>

            <!-- Badge sessioni (countdown) -->
            <div class="timer-sess-info" id="timerSessInfo" style="margin-bottom:16px;"></div>

            <!-- Ring countdown -->
            <div id="timerRunCountdown">
              <div class="timer-ring">
                <svg width="180" height="180" viewBox="0 0 180 180">
                  <circle class="t-track" cx="90" cy="90" r="80"/>
                  <circle class="t-arc" id="tArc" cx="90" cy="90" r="80" stroke-dasharray="502" stroke-dashoffset="0"/>
                </svg>
                <div class="timer-disp" id="tDisp">25:00</div>
              </div>
              <div id="timerPhaseLabel" style="font-size:12px;color:var(--ink3);margin-bottom:16px;height:18px;"></div>
            </div>

            <!-- Display timer libero -->
            <div id="timerRunFree" style="display:none;">
              <div class="timer-free-disp" id="tFreeDisp">00:00</div>
              <div style="font-size:12px;color:var(--ink3);margin-bottom:24px;">Ferma quando hai finito</div>
            </div>

            <div class="timer-btns">
              <button class="btn" id="tPauseBtn" onclick="UI.timerPause()">Pausa</button>
              <button class="btn btn-danger" onclick="UI.timerEnd()">Fine sessione</button>
            </div>
            <div style="font-size:12px;color:var(--ink3);">Sessione: <strong id="tTopicSm"></strong></div>
          </div>
        </div>

      </div>
      <div id="studiaDone" style="display:none">
        <div class="timer-wrap" style="text-align:left;max-width:460px;">
          <div style="font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--ink3);margin-bottom:4px;">Sessione completata</div>
          <div class="ph" id="dTopic" style="font-size:20px;margin-bottom:2px;"></div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
            <span style="font-size:13px;color:var(--ink3);" id="dDur"></span>
            <span style="font-size:12px;color:var(--amber);font-weight:500;" id="dExamInfo"></span>
          </div>
          <div class="sec" style="margin-bottom:6px;">QUANTO L'HAI SAPUTO?</div>
          <div style="display:flex;justify-content:space-between;font-size:10.5px;color:var(--ink3);margin-bottom:5px;">
            <span>1 â€” Facilissimo</span><span style="text-align:center;flex:1;">Â· Â· Â·</span><span>10 â€” Difficilissimo</span>
          </div>
          <div class="diff-grid" id="diffGrid"></div>
          <div id="dPlanPreview" class="plan-preview">Seleziona una difficoltÃ  per vedere il piano di ripassi.</div>
          <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px;" onclick="UI.timerConfirm()">
            Salva e aggiorna calendario â†’
          </button>
        </div>
      </div>
    </div>

    <!-- CALENDARIO -->
    <div class="page" id="page-calendario">
      <div class="ph">Calendario</div>
      <div class="ps">Ripassi pianificati Â· gerarchia completa Â· clicca un giorno per i dettagli</div>
      <div class="cal-header">
        <div class="cal-tabs">
          <button class="cal-tab active" onclick="UI.setCalTab('month',this)">Mensile</button>
          <button class="cal-tab" onclick="UI.setCalTab('week',this)">Settimanale</button>
          <button class="cal-tab" onclick="UI.setCalTab('3day',this)">3 giorni</button>
          <button class="cal-tab" onclick="UI.setCalTab('day',this)">Giornaliera</button>
        </div>
        <div class="cal-nav">
          <button class="btn btn-ghost btn-sm" onclick="UI.calMove(-1)">â€¹</button>
          <div class="cal-nav-title" id="calTitle"></div>
          <button class="btn btn-ghost btn-sm" onclick="UI.calMove(1)">â€º</button>
        </div>
      </div>
      <div id="calBody"></div>
    </div>

    <!-- SIMULAZIONE -->
    <div class="page" id="page-simulazione">
      <div class="ph">Simulazione Pre-Esame</div>
      <div class="ps">Stima del rischio di mancato consolidamento per ogni materia con esame imminente.</div>
      <div id="simBody"></div>
    </div>

    <!-- STATISTICHE -->
    <div class="page" id="page-statistiche">
      <div class="ph">Statistiche</div>
      <div class="ps">Ore di studio, tendenze e distribuzione per materia. <button class="btn btn-ghost btn-xs" onclick="UI.goto('classifica')" style="font-size:11px;vertical-align:middle;">â†— Classifica settimane</button></div>

      <!-- Strip KPI -->
      <div class="strip" style="margin-bottom:20px;">
        <div class="strip-cell"><div class="strip-val" id="stOre">0</div><div class="strip-lbl">Ore questa settimana</div></div>
        <div class="strip-cell"><div class="strip-val" id="stOreMese">0</div><div class="strip-lbl">Ore questo mese</div></div>
        <div class="strip-cell"><div class="strip-val" id="stStreak">0</div><div class="strip-lbl">Giorni di fila</div></div>
        <div class="strip-cell"><div class="strip-val" id="stRev">0</div><div class="strip-lbl">Ripassi completati</div></div>
      </div>

      <!-- Obiettivo settimanale -->
      <div class="card" style="margin-bottom:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div class="sec" style="margin:0;">OBIETTIVO SETTIMANALE</div>
          <span id="stGoalLabel" style="font-size:12px;color:var(--ink3);"></span>
        </div>
        <div style="height:8px;background:var(--paper3);border-radius:99px;overflow:hidden;margin-bottom:8px;">
          <div id="stGoalBar" style="height:100%;width:0%;background:var(--green);border-radius:99px;transition:width .6s;"></div>
        </div>
        <div id="stGoalHint" style="font-size:11.5px;color:var(--ink3);"></div>
      </div>

      <!-- Grafico ore ultimi 30gg -->
      <div class="sec">ORE DI STUDIO â€” ULTIMI 30 GIORNI</div>
      <div id="chart30Wrap" style="display:flex;align-items:flex-end;gap:2px;height:72px;margin-bottom:4px;"></div>
      <div id="chart30Labels" style="display:flex;justify-content:space-between;font-size:9.5px;color:var(--ink3);font-family:var(--mono);margin-bottom:22px;"></div>

      <!-- Grafico ore per materia -->
      <div class="sec">ORE PER MATERIA</div>
      <div id="oreMaterie" style="margin-bottom:24px;"></div>

      <!-- Top argomenti per ore -->
      <div class="sec">TOP ARGOMENTI PER ORE STUDIATE</div>
      <div id="oreArgomenti" style="margin-bottom:24px;"></div>

      <!-- g2: CFU + DifficoltÃ  -->
      <div class="g2" style="margin-bottom:24px;">
        <div><div class="sec">DISTRIBUZIONE CFU</div><div id="cfuChart"></div></div>
        <div><div class="sec">DIFFICOLTÃ€ MEDIA</div><div id="diffChart"></div></div>
      </div>

      <hr>
      <div class="sec">SESSIONI RECENTI</div>
      <div id="recentList"></div>
    </div>

    <!-- CLASSIFICA -->
    <div class="page" id="page-classifica">
      <div class="ph">Classifica Settimane</div>
      <div class="ps">Confronto settimanale Â· top settimane Â· feedback sul tuo progresso.</div>

      <!-- Confronto: settimana corrente vs precedente -->
      <div class="card" id="wkCompareCard" style="margin-bottom:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div class="sec" style="margin:0;">SETTIMANA IN CORSO</div>
          <button class="btn btn-sm" id="wkCloseBtn" onclick="UI.closeWeek()">âœ“ Concludi settimana</button>
        </div>
        <div id="wkCompareBars" style="margin-bottom:14px;"></div>
        <div id="wkMotiv" style="font-size:13px;padding:10px 12px;border-radius:var(--r);background:var(--paper2);border:1px solid var(--line);"></div>
      </div>

      <!-- Controllo confronto -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
        <span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);">Confronta per</span>
        <div style="display:flex;gap:3px;background:var(--paper3);padding:3px;border-radius:var(--r);">
          <button class="cal-tab active" id="wkModeOre"     onclick="UI.setWkMode('ore',this)">Ore totali</button>
          <button class="cal-tab"        id="wkModeMateria" onclick="UI.setWkMode('materia',this)">Per materia</button>
          <button class="cal-tab"        id="wkModeRevs"    onclick="UI.setWkMode('revs',this)">Ripassi</button>
        </div>
      </div>

      <!-- Podio top 3 -->
      <div class="sec">ğŸ† TOP 3 SETTIMANE</div>
      <div id="wkPodio" style="margin-bottom:24px;"></div>

      <!-- Storico completo -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="sec" style="margin:0;">STORICO</div>
        <span style="font-size:11px;color:var(--ink3);" id="wkLogCount"></span>
      </div>
      <div id="wkLog" style="margin-bottom:24px;"></div>
    </div>

    <!-- IMPOSTAZIONI -->
    <div class="page" id="page-impostazioni">
      <div class="ph">Impostazioni</div>
      <div class="ps">Preferenze, backup e ripristino dati.</div>
      <div class="g2">
        <div class="card">
          <div class="sec">PREFERENZE</div>
          <div class="field"><div class="flbl">Nome</div><input class="inp" id="iPName" placeholder="Come ti chiami?"></div>
          <div class="field"><div class="flbl">Durata sessione countdown (min)</div><input class="inp" id="iPDur" type="number" min="5" max="120" value="25"></div>
          <div class="field"><div class="flbl">Max materie per giorno</div><input class="inp" id="iPMax" type="number" min="1" max="5" value="3"></div>
          <div class="field"><div class="flbl">Obiettivo ore/settimana</div><input class="inp" id="iPGoal" type="number" min="1" max="80" value="10" placeholder="10"></div>
          <!-- TEMA -->
          <div class="field">
            <div class="flbl">Tema</div>
            <div style="display:flex;gap:8px;margin-top:4px;">
              <button class="btn btn-sm" id="btnThemeLight" onclick="UI.setTheme('light')">â˜€ Light</button>
              <button class="btn btn-sm" id="btnThemeDark"  onclick="UI.setTheme('dark')">ğŸŒ™ Dark</button>
            </div>
          </div>
          <!-- PRESET TIMER -->
          <div style="margin-top:12px;">
            <div class="sec" style="margin-bottom:8px;">PRESET TIMER</div>
            <div id="presetList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;"></div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;">
              <div><div class="flbl" style="font-size:10px;margin-bottom:3px;">Nome</div><input class="inp" id="iPresetName" placeholder="es. Studio lungo" style="width:130px;"></div>
              <div><div class="flbl" style="font-size:10px;margin-bottom:3px;">Min studio</div><input class="inp" id="iPresetStudy" type="number" value="60" min="5" max="180" style="width:72px;"></div>
              <div><div class="flbl" style="font-size:10px;margin-bottom:3px;">Min pausa</div><input class="inp" id="iPresetBreak" type="number" value="10" min="0" max="60" style="width:72px;"></div>
              <div><div class="flbl" style="font-size:10px;margin-bottom:3px;">N sessioni</div><input class="inp" id="iPresetSess" type="number" value="2" min="1" max="8" style="width:72px;"></div>
              <button class="btn btn-sm" onclick="UI.addPreset()">+ Aggiungi</button>
            </div>
          </div>
          <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="UI.savePrefs()">Salva</button>
        </div>
        <div class="card">
          <div class="sec">BACKUP</div>
          <p style="font-size:13px;color:var(--ink2);margin-bottom:14px;line-height:1.6;">Esporta tutti i dati in JSON per backup o migrazione su altro dispositivo.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-sm" onclick="EIM.exportJSON()">â¬‡ Esporta JSON</button>
            <label class="btn btn-sm" style="cursor:pointer;">â¬† Importa JSON<input type="file" accept=".json" style="display:none" onchange="EIM.importJSON(this)"></label>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:10px;">
        <div class="sec">ZONA PERICOLOSA</div>
        <p style="font-size:13px;color:var(--ink2);margin-bottom:14px;line-height:1.6;">Elimina permanentemente tutti i dati: materie, argomenti, sessioni, calendario.</p>
        <button class="btn btn-danger btn-sm" onclick="UI.confirmReset()">â†º Reset completo</button>
      </div>
    </div>

  </div>
</div>
</div>

<!-- MODALS -->
<div class="ov" id="ovSubj">
  <div class="modal">
    <div class="modal-title" id="mSubjT">Nuova materia</div>
    <div class="field"><div class="flbl">Nome *</div><input class="inp" id="fSName" placeholder="es. Analisi Matematica II"></div>
    <div class="g2">
      <div class="field"><div class="flbl">CFU</div><input class="inp" id="fSCFU" type="number" min="1" max="30" placeholder="6"></div>
      <div class="field"><div class="flbl">Data esame</div><input class="inp" id="fSExam" type="date"></div>
    </div>
    <div class="field"><div class="flbl">Colore</div><input class="inp" id="fSColor" type="color" value="#D97706"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="UI.closeOv('ovSubj')">Annulla</button>
      <button class="btn btn-primary" onclick="UI.saveSubj()">Salva</button>
    </div>
  </div>
</div>

<div class="ov" id="ovTopic">
  <div class="modal">
    <div class="modal-title" id="mTopicT">Nuovo argomento</div>
    <div class="field"><div class="flbl">Titolo *</div><input class="inp" id="fTTitle" placeholder="es. Limiti e ContinuitÃ "></div>
    <div class="g2">
      <div class="field"><div class="flbl">Materia</div><select class="inp" id="fTSubj"></select></div>
      <div class="field"><div class="flbl">Livello</div>
        <select class="inp" id="fTLevel">
          <option value="0">Argomento</option>
          <option value="1">Sotto-argomento</option>
          <option value="2">Micro-argomento</option>
        </select>
      </div>
    </div>
    <div class="field"><div class="flbl">Genitore (opzionale)</div><select class="inp" id="fTParent"><option value="">â€” Nessuno (radice) â€”</option></select></div>
    <div class="field">
      <div class="flbl">DifficoltÃ  iniziale: <span id="fTDV">3</span>/5</div>
      <input class="inp" type="range" id="fTDiff" min="1" max="5" value="3" oninput="document.getElementById('fTDV').textContent=this.value">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="UI.closeOv('ovTopic')">Annulla</button>
      <button class="btn btn-primary" onclick="UI.saveTopic()">Salva</button>
    </div>
  </div>
</div>

<div class="ov" id="ovMove">
  <div class="modal">
    <div class="modal-title">Sposta argomento</div>
    <div class="field"><div class="flbl">Nuova materia</div><select class="inp" id="fMSubj"></select></div>
    <div class="field"><div class="flbl">Nuovo genitore</div><select class="inp" id="fMParent"><option value="">â€” Nessuno â€”</option></select></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="UI.closeOv('ovMove')">Annulla</button>
      <button class="btn btn-primary" onclick="UI.doMove()">Sposta</button>
    </div>
  </div>
</div>

<div class="dpop" id="dpop">
  <div class="dpop-box">
    <div class="dpop-h"><div class="dpop-t" id="dpopTitle"></div><button class="btn btn-ghost btn-sm btn-icon" onclick="document.getElementById('dpop').classList.remove('open')">âœ•</button></div>
    <div class="dpop-body" id="dpopBody"></div>
  </div>
</div>

<div class="cf" id="cfBox">
  <div class="cf-box">
    <div class="cf-title" id="cfTitle">Conferma</div>
    <div class="cf-body" id="cfBody"></div>
    <div class="cf-btns">
      <button class="btn btn-ghost" onclick="UI.cfCancel()">Annulla</button>
      <button class="btn btn-danger" onclick="UI.cfOk()">Conferma</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 1 â€” DataManager
   CRUD, persistenza localStorage, generazione ID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DM = (() => {
  const KEY = 'sp5';
  const mkDefault = () => ({
    prefs: { name:'', dur:25, maxSubjDay:3, weeklyGoalMins:600, theme:'light', timerPresets:[], lastTimerCfg:{study:25,brk:5,sessions:1,mode:'countdown'} },
    subjects:[], topics:[], sessions:[], reviews:[], weeklyLogs:[], _id:1
  });
  let DB = mkDefault();

  const load  = () => { try { const s=localStorage.getItem(KEY); if(s) DB={...mkDefault(),...JSON.parse(s)}; if(!DB._id)DB._id=1; } catch(e){} };
  const save  = () => localStorage.setItem(KEY, JSON.stringify(DB));
  const uid   = () => 'e'+(DB._id++)+'_'+Date.now().toString(36);
  const reset = () => { DB=mkDefault(); save(); };

  // Date utils
  const todayStr = () => new Date().toISOString().slice(0,10);
  const addDays  = (s,n) => { const d=new Date(s+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); };
  const daysUntil= (s) => { if(!s) return 9999; const d=new Date(s+'T00:00:00'); d.setHours(0,0,0,0); const t=new Date(); t.setHours(0,0,0,0); return Math.round((d-t)/86400000); };

  // Subjects
  const getSubjects   = ()   => DB.subjects.filter(s=>s.stato!=='archiviata');
  const getAllSubjects = ()   => DB.subjects;
  const getSubject    = id   => DB.subjects.find(s=>s.id===id);
  const addSubject    = data => { const s={id:uid(),nome:data.nome,dataEsame:data.dataEsame||null,cfu:+data.cfu||6,colore:data.colore||'#D97706',stato:'attiva',creatoIl:todayStr()}; DB.subjects.push(s); save(); return s; };
  const updateSubject = (id,data) => { const s=DB.subjects.find(x=>x.id===id); if(s){Object.assign(s,data);save();} };
  const deleteSubject = id => {
    // Raccoglie tutti i topicId della materia (inclusi annidati)
    const topicIds = new Set(DB.topics.filter(t=>t.subjectId===id).map(t=>t.id));
    DB.subjects = DB.subjects.filter(s=>s.id!==id);
    DB.topics   = DB.topics.filter(t=>t.subjectId!==id);
    DB.reviews  = DB.reviews.filter(r=>r.subjectId!==id && !topicIds.has(r.topicId));
    DB.sessions = DB.sessions.filter(s=>!topicIds.has(s.idArgomento));
    save();
  };

  // Topics
  // Raccoglie ricorsivamente tutti gli id discendenti di un topic (incluso se stesso)
  const _allDescendants = id => {
    const ids=[id];
    DB.topics.filter(t=>t.parentId===id).forEach(t=>ids.push(..._allDescendants(t.id)));
    return ids;
  };
  const getTopics    = sid  => DB.topics.filter(t=>t.subjectId===sid&&!t.del);
  const getAllTopics  = ()   => DB.topics.filter(t=>!t.del);
  const getTopic     = id   => DB.topics.find(t=>t.id===id);
  const getChildren  = pid  => DB.topics.filter(t=>t.parentId===pid&&!t.del);
  const addTopic     = data => {
    const t={id:uid(),subjectId:data.subjectId,parentId:data.parentId||null,titolo:data.titolo,livello:+data.livello||0,
      difficolta:+data.difficolta||3,numeroRipassi:0,dataUltimoRipasso:null,intervalloCorrente:0,
      statoMemoria:'instabile',prioritaCalcolata:0,creatoIl:todayStr()};
    DB.topics.push(t); save(); return t;
  };
  const updateTopic  = (id,data) => { const t=DB.topics.find(x=>x.id===id); if(t){Object.assign(t,data);save();} };
  // hardDel: elimina topic + tutti i discendenti + le loro review + sessioni
  const hardDel = id => {
    const ids = _allDescendants(id);
    const idSet = new Set(ids);
    DB.topics   = DB.topics.filter(t=>!idSet.has(t.id));
    DB.reviews  = DB.reviews.filter(r=>!idSet.has(r.topicId));
    DB.sessions = DB.sessions.filter(s=>!idSet.has(s.idArgomento));
    save();
  };
  // Lasciamo softDel e restoreTopic per compatibilitÃ  undo-toast, ma dopo commit chiamano hardDel
  const softDel      = id => { const ids=_allDescendants(id); ids.forEach(tid=>{const t=DB.topics.find(x=>x.id===tid);if(t)t.del=true;}); save(); };
  const restoreTopic = id => { const ids=_allDescendants(id); ids.forEach(tid=>{const t=DB.topics.find(x=>x.id===tid);if(t)delete t.del;}); save(); };

  // Sessions
  const getSessions = () => DB.sessions;
  const addSession  = data => { const s={id:uid(),data:data.data||todayStr(),idArgomento:data.idArgomento,durataEffettiva:data.durataEffettiva||0,difficolta:data.difficolta||3}; DB.sessions.push(s); save(); return s; };

  // Reviews
  const getReviews      = ()  => DB.reviews;
  const getRevsByDate   = d   => DB.reviews.filter(r=>r.data===d);
  const setReviews      = arr => { DB.reviews=arr; save(); };
  const markRevDone     = id  => { const r=DB.reviews.find(x=>x.id===id); if(r){r.done=true;r.doneAt=todayStr();save();} };
  const snoozeRev = (id, days) => {
    const r = DB.reviews.find(x => x.id === id);
    if (!r || r.done) return null;
    r.data = addDays(r.data, days);
    r.snoozeCount = (r.snoozeCount || 0) + 1;
    save(); return r.data;
  };

  // Prefs
  const getPrefs    = ()  => DB.prefs;
  const updatePrefs = p   => { Object.assign(DB.prefs,p); save(); };

  // WeeklyLogs â€” storico settimane concluse
  const getWeeklyLogs   = ()      => DB.weeklyLogs || [];
  const addWeeklyLog    = entry   => {
    if (!DB.weeklyLogs) DB.weeklyLogs = [];
    DB.weeklyLogs.push(entry); save(); return entry;
  };
  const updateWeeklyLog = (wk, data) => {
    if (!DB.weeklyLogs) return;
    const log = DB.weeklyLogs.find(l => l.weekKey === wk);
    if (log) { Object.assign(log, data); save(); }
  };

  // Export / Import
  const exportAll = ()  => JSON.stringify(DB,null,2);
  const importAll = s   => { DB={...mkDefault(),...JSON.parse(s)}; save(); };

  load();
  return { load,save,uid,reset,todayStr,addDays,daysUntil,
    getSubjects,getAllSubjects,getSubject,addSubject,updateSubject,deleteSubject,
    getTopics,getAllTopics,getTopic,getChildren,addTopic,updateTopic,softDel,hardDel,restoreTopic,
    getSessions,addSession,getReviews,getRevsByDate,setReviews,markRevDone,snoozeRev,
    getPrefs,updatePrefs,getWeeklyLogs,addWeeklyLog,updateWeeklyLog,exportAll,importAll };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 2 â€” AlgorithmEngine
   SRS adattivo 1â€“10 Â· generazione sequenza completa
   Â· ricalcolo dinamico Â· vincoli esame
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AE = (() => {

  /*
   * PARAMETRI SRS ADATTIVO (scala difficoltÃ  1â€“10)
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * targetCount: numero totale ripassi da generare [3â€“7]
   * baseIntervals: intervalli base in giorni (sempre crescenti)
   *
   * DifficoltÃ  1â€“3 (bassa):  3 ripassi, intervalli distanziati
   * DifficoltÃ  4â€“6 (media):  5 ripassi, intervalli medi
   * DifficoltÃ  7â€“10 (alta):  7 ripassi, intervalli brevi
   *
   * Il sistema genera TUTTA la sequenza futura in anticipo,
   * la salva su topic.reviewPlan, e la cancella/rigenera
   * ad ogni nuova valutazione di difficoltÃ  percepita.
   */
  function _srsParams(diff10) {
    const d = Math.min(10, Math.max(1, Math.round(diff10)));
    if (d <= 3) return { count: 3, factors: [0.08, 0.20, 1.00] };
    if (d <= 6) return { count: 5, factors: [0.05, 0.12, 0.25, 0.55, 1.00] };
    return       { count: 7, factors: [0.03, 0.07, 0.13, 0.22, 0.38, 0.65, 1.00] };
  }

  /*
   * generatePlan â€” genera la sequenza COMPLETA di date di ripasso
   *
   * Algoritmo:
   * 1. Calcola il finestra temporale disponibile: [oggi+1, dataEsame-1]
   * 2. Distribuisce i `count` ripassi usando i `factors` (0â†’inizio, 1â†’fine finestra)
   * 3. Garantisce un ultimo ripasso entro 3 giorni dall'esame
   * 4. Non produce date duplicate o fuori finestra
   * 5. Ordina e de-duplica
   *
   * @param diff10     difficoltÃ  percepita 1â€“10
   * @param examDate   stringa YYYY-MM-DD, puÃ² essere null
   * @param fromDate   stringa YYYY-MM-DD punto di partenza (default: oggi)
   * @param doneCount  ripassi giÃ  effettuati (per il conteggio max 7 totali)
   * @returns array di stringhe YYYY-MM-DD, mai vuoto
   */
  function generatePlan(diff10, examDate, fromDate, doneCount) {
    /*
     * Genera la sequenza COMPLETA di ripassi futuri.
     *
     * Parametri:
     *   diff10    â€” difficoltÃ  percepita 1â€“10 (guida numero + densitÃ  ripassi)
     *   examDate  â€” YYYY-MM-DD, puÃ² essere null (senza scadenza â†’ finestra 180gg)
     *   fromDate  â€” punto di partenza (default: oggi)
     *   doneCount â€” ripassi giÃ  completati (per rispettare il cap di 7 totali)
     *
     * Algoritmo:
     *   1. Determina quanti ripassi futuri generare (cap 7 totali âˆ’ giÃ  fatti)
     *   2. Calcola la finestra [start = fromDate+1 â€¦ end = examDate-1 o +180gg]
     *   3. Se finestra < count, comprime: usa giorni consecutivi da start
     *   4. Altrimenti distribuisce i ripassi con fattori proporzionali alla diff:
     *      - diff alta  â†’ ripassi concentrati nella prima metÃ  (esponenziale breve)
     *      - diff bassa â†’ ripassi distribuiti uniformemente
     *   5. Garantisce sempre un ripasso nell'ultimo slot pre-esame (â‰¤3gg prima)
     *   6. De-duplica e ordina
     */
    fromDate  = fromDate  || DM.todayStr();
    doneCount = doneCount || 0;
    const d   = Math.min(10, Math.max(1, Math.round(diff10 || 5)));

    // Numero ripassi futuri: basato su difficoltÃ , rispettando cap 7
    const params   = _srsParams(d);
    const maxFuture = Math.max(0, 7 - doneCount);
    // Se l'argomento Ã¨ giÃ  stato visto molte volte e diff Ã¨ bassa â†’ puÃ² scendere a 1
    const minFuture = doneCount === 0 ? 3 : (d <= 3 && doneCount >= 3 ? 0 : 1);
    const wantedCount = Math.min(params.count, maxFuture);
    const count = Math.max(minFuture, Math.min(wantedCount, maxFuture));

    if (count <= 0) return [];

    // Finestra temporale
    const startD = new Date(DM.addDays(fromDate, 1) + 'T00:00:00');
    let endD;
    if (examDate) {
      const dte = DM.daysUntil(examDate);
      if (dte <= 1) return [];
      // Fine = giorno prima dell'esame
      endD = new Date(DM.addDays(examDate, -1) + 'T00:00:00');
    } else {
      endD = new Date(DM.addDays(fromDate, 180) + 'T00:00:00');
    }

    const winDays = Math.max(1, Math.round((endD - startD) / 86400000) + 1);
    const toDateStr = d => d.toISOString().slice(0, 10);
    const addD = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };

    // Se la finestra Ã¨ troppo stretta per i ripassi, usa giorni consecutivi
    if (winDays <= count) {
      const dates = [];
      for (let i = 0; i < Math.min(count, winDays); i++) {
        dates.push(toDateStr(addD(startD, i)));
      }
      return [...new Set(dates)].sort();
    }

    /*
     * Distribuzione proporzionale con curva adattiva:
     * - diff 1â€“3: distribuzione UNIFORME (spaziatura costante)
     * - diff 4â€“6: spaziatura PROGRESSIVA (intervalli crescenti)
     * - diff 7â€“10: CONCENTRATA all'inizio + spike finale pre-esame
     *
     * I "factor" mappano [0, 1] â†’ [0, winDays-1] (offset da startD)
     */
    let factors = params.factors.slice(0, count);
    // Ridimensiona factors per finestre corte: scala i valori dentro [0,1]
    const maxF = factors[factors.length - 1] || 1;
    factors = factors.map(f => f / maxF);

    const dateSet = new Set();

    factors.forEach((f, i) => {
      const isLast = i === factors.length - 1;
      let offset;
      if (isLast && examDate) {
        // Ultimo ripasso: piazza entro 1â€“3 giorni dall'esame
        const dte = DM.daysUntil(examDate);
        const preExamOffset = Math.max(1, dte - Math.min(3, Math.ceil(dte * 0.12)));
        offset = Math.min(winDays - 1, preExamOffset - 1);
      } else {
        offset = Math.round(f * (winDays - 1));
      }
      offset = Math.max(0, Math.min(winDays - 1, offset));
      const date = toDateStr(addD(startD, offset));
      if (date <= toDateStr(endD)) dateSet.add(date);
    });

    // Se ci sono collisioni (date duplicate), risolvi spostando al giorno successivo
    const sorted = [...dateSet].sort();
    const resolved = [];
    for (let i = 0; i < sorted.length; i++) {
      let d = sorted[i];
      // Evita duplicati con resolved
      while (resolved.includes(d)) {
        const nxt = new Date(d + 'T00:00:00');
        nxt.setDate(nxt.getDate() + 1);
        d = toDateStr(nxt);
        if (d > toDateStr(endD)) { d = null; break; }
      }
      if (d && d <= toDateStr(endD)) resolved.push(d);
    }

    return resolved.sort();
  }

  /*
   * applySession â€” chiamato dopo ogni sessione di studio o ripasso
   *
   * 1. Aggiorna i contatori del topic (numeroRipassi, dataUltimoRipasso)
   * 2. Salva la difficoltÃ  percepita attuale (diff10, scala 1â€“10)
   * 3. Cancella TUTTI i ripassi futuri pianificati per questo topic
   * 4. Rigenera la sequenza completa con generatePlan()
   * 5. Salva il piano su topic.reviewPlan (array di date)
   * 6. Imposta nextRev = prima data del nuovo piano
   *
   * @param topicId  id del topic
   * @param diff10   difficoltÃ  percepita 1â€“10
   * @returns { nextRev, plan } oppure { nextRev: null, plan: [] } se nessun ripasso
   */
  function applySession(topicId, diff10) {
    const t = DM.getTopic(topicId); if (!t) return { nextRev: null, plan: [] };
    const s = DM.getSubject(t.subjectId);

    // Aggiorna contatori
    t.difficoltaPercepita = diff10;
    t.numeroRipassi       = (t.numeroRipassi || 0) + 1;
    t.dataUltimoRipasso   = DM.todayStr();

    // Genera il piano futuro completo
    const plan = generatePlan(diff10, s ? s.dataEsame : null, DM.todayStr(), t.numeroRipassi);
    t.reviewPlan         = plan;
    t.nextRev            = plan[0] || null;
    t.intervalloCorrente = plan.length > 0
      ? Math.max(1, Math.round((new Date(plan[0]+'T00:00:00') - new Date(DM.todayStr()+'T00:00:00')) / 86400000))
      : 0;

    // Stato memoria basato su difficoltÃ  e numero ripassi completati
    t.statoMemoria     = calcMemoryState(t);
    t.prioritaCalcolata= calcPriority(t, s);
    DM.updateTopic(topicId, t);

    // Rimuovi review future di questo topic e reinserisci dal piano
    const existingRevs = DM.getReviews().filter(r => !(r.topicId === topicId && !r.done));
    const newRevs = plan.map(date => ({
      id: DM.uid(), topicId, subjectId: t.subjectId, data: date, done: false, ps: t.prioritaCalcolata
    }));
    DM.setReviews([...existingRevs, ...newRevs]);

    return { nextRev: plan[0] || null, plan };
  }

  /*
   * calcMemoryState â€” basato su difficoltÃ  percepita e progressi
   * instabile:       diff >= 7 o meno di 2 ripassi
   * consolidamento:  diff 4â€“6 o ripassi 2â€“4
   * consolidato:     diff <= 3 e almeno 3 ripassi
   */
  function calcMemoryState(topic) {
    const d = topic.difficoltaPercepita || topic.difficolta || 5;
    const n = topic.numeroRipassi || 0;
    if (d <= 3 && n >= 3) return 'consolidato';
    if (d <= 6 && n >= 2) return 'consolidamento';
    return 'instabile';
  }

  /*
   * calcPriority â€” funzione multivariabile [0, 1]
   * Pesi: urgenza esame 40% Â· difficoltÃ  percepita 30% Â· stato memoria 20% Â· CFU 10%
   */
  function calcPriority(topic, subject) {
    const dte     = DM.daysUntil(subject ? subject.dataEsame : null);
    const urgency = 1 / (1 + dte / 25);
    const d10     = topic.difficoltaPercepita || topic.difficolta || 5;
    const diffN   = Math.min(10, Math.max(1, d10)) / 10;
    const memScore= {instabile:1.0, consolidamento:0.5, consolidato:0.1}[topic.statoMemoria] || 1.0;
    const allSubj = DM.getSubjects();
    const totCFU  = allSubj.reduce((a,s)=>a+(s.cfu||6),0);
    const cfuW    = totCFU > 0 ? (subject ? (subject.cfu||6) / totCFU : 0.3) : 0.3;
    return (0.40 * urgency) + (0.30 * diffN) + (0.20 * memScore) + (0.10 * cfuW);
  }

  /*
   * calcDayLoad â€” carico cognitivo giornaliero normalizzato [0, 1]
   */
  function calcDayLoad(reviews) {
    if (!reviews.length) return 0;
    const allSubj = DM.getSubjects();
    const totCFU  = allSubj.reduce((a,s)=>a+(s.cfu||6),0);
    let load = 0;
    reviews.forEach(r => {
      const t = DM.getTopic(r.topicId);
      const s = allSubj.find(x=>x.id===r.subjectId);
      if (!t || !s) return;
      const dte   = DM.daysUntil(s.dataEsame);
      const urg   = 1 / (1 + dte / 25);
      const d10   = t.difficoltaPercepita || t.difficolta || 5;
      const diffN = Math.min(10, Math.max(1, d10)) / 10;
      const cfuN  = totCFU > 0 ? (s.cfu||6) / totCFU : 0.3;
      load += diffN * cfuN * (0.4 + urg * 0.6);
    });
    return Math.min(1, load / 3);
  }

  /* targetReviews â€” numero previsto di ripassi futuri per questa difficoltÃ  */
  function targetReviews(diff10) {
    return _srsParams(Math.min(10, Math.max(1, Math.round(diff10 || 5)))).count;
  }

  /* refreshAll â€” ricalcola stati/prioritÃ ; ripristina nextRev dai reviewPlan */
  function refreshAll() {
    const allSubj = DM.getSubjects();
    DM.getAllTopics().forEach(t => {
      const s          = allSubj.find(x=>x.id===t.subjectId);
      const hasChildren= DM.getChildren(t.id).length > 0;
      t.statoMemoria     = calcMemoryState(t);
      t.prioritaCalcolata= calcPriority(t, s);
      if (hasChildren) { t.nextRev = null; t.intervalloCorrente = 0; }
      else if (t.reviewPlan && t.reviewPlan.length > 0) {
        // Aggiorna nextRev alla prima data futura del piano
        const td = DM.todayStr();
        const future = t.reviewPlan.filter(d => d > td);
        t.nextRev = future[0] || null;
      }
      DM.updateTopic(t.id, t);
    });
  }


  function snoozeIntelligent(topicId) {
    var t = DM.getTopic(topicId); if (!t) return null;
    var s = DM.getSubject(t.subjectId);
    var today = DM.todayStr();
    var examDate = s ? s.dataEsame : null;
    var rev = DM.getReviews().find(function(r){
      return r.topicId === topicId && r.data === today && !r.done;
    });
    if (!rev) return null;
    var daysToExam = examDate ? DM.daysUntil(examDate) : 999;
    var win = Math.min(7, Math.max(1, Math.floor(daysToExam / 3)));
    var newDate = null;
    for (var i = 1; i <= win; i++) {
      var d = DM.addDays(today, i);
      if (examDate && d >= examDate) break;
      var dayRevs = DM.getRevsByDate(d);
      var load = calcDayLoad(dayRevs);
      var clash = dayRevs.some(function(r){ return r.topicId === topicId; });
      if (load < 0.70 && !clash) { newDate = d; break; }
    }
    if (!newDate) newDate = DM.addDays(today, 1);
    var shift = Math.round((new Date(newDate+'T00:00:00') - new Date(today+'T00:00:00')) / 86400000);
    DM.snoozeRev(rev.id, shift);
    if (t.reviewPlan) {
      var idx2 = t.reviewPlan.indexOf(today);
      if (idx2 !== -1) {
        t.reviewPlan[idx2] = newDate;
        t.reviewPlan = t.reviewPlan.filter(function(x, i, a){ return a.indexOf(x)===i; }).sort();
      }
    }
    t.nextRev = t.reviewPlan
      ? (t.reviewPlan.filter(function(dd){ return dd > today; })[0] || null)
      : newDate;
    var sc = (rev.snoozeCount || 0) + 1;
    if (sc >= 3) t.prioritaCalcolata = Math.min(1, (t.prioritaCalcolata || 0) + 0.15);
    DM.updateTopic(topicId, t);
    var warning = null;
    if (examDate) {
      var dte2 = DM.daysUntil(examDate);
      if (dte2 <= 5) {
        var dense = DM.getReviews().filter(function(r){
          return !r.done && r.data >= today && r.data < examDate && r.subjectId === t.subjectId;
        }).length;
        if (dense >= dte2 * 2)
          warning = 'Attenzione: ' + dense + ' ripassi in ' + dte2 + ' giorni prima dellâ€™esame.';
      }
    }
    if (sc >= 3 && !warning)
      warning = 'Rimandato ' + sc + ' volte. PrioritÃ  aumentata.';
    return { newDate: newDate, warning: warning };
  }

  return { generatePlan, applySession, calcMemoryState, calcPriority,
           calcDayLoad, targetReviews, refreshAll, snoozeIntelligent };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 3 â€” Scheduler
   Ricostruisce DB.reviews dai reviewPlan dei topic
   Â· vincolo max-materie/giorno Â· bump overflow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Sched = (() => {

  function isLeaf(id) { return DM.getChildren(id).length === 0; }

  /*
   * build â€” ricostruisce il calendario completo
   *
   * Regole:
   * - Solo topic FOGLIA vengono schedulati
   * - Usa topic.reviewPlan (array di date) generato da AE.applySession()
   * - Le review giÃ  completate (done=true) vengono preservate
   * - Applica vincolo max N materie distinte per giorno
   * - Non produce duplicati per lo stesso (topicId, data)
   */
  function build() {
    const td   = DM.todayStr();
    const maxS = DM.getPrefs().maxSubjDay || 3;
    const allSubj = DM.getSubjects();

    // Preserva review completate O snoozate (hanno giÃ  la data corretta)
    const kept = DM.getReviews().filter(r => r.done || (r.snoozeCount && r.snoozeCount > 0 && !r.done));
    const keptKey = new Set(kept.map(r => r.topicId + '|' + r.data));

    // Raccoglie tutte le date future dai reviewPlan
    const cal = {}; // { date: [ {topicId, subjectId, ps} ] }

    DM.getAllTopics().forEach(t => {
      if (!isLeaf(t.id))           return;
      if (!t.reviewPlan || !t.reviewPlan.length) return;
      const s = allSubj.find(x => x.id === t.subjectId);
      if (!s)                       return;
      const ps = t.prioritaCalcolata || AE.calcPriority(t, s);

      t.reviewPlan.forEach(date => {
        if (date <= td) return;
        if (keptKey.has(t.id + '|' + date)) return;
        if (s.dataEsame && date >= s.dataEsame) return; // sicurezza: non oltre esame
        (cal[date] = cal[date] || []).push({ topicId: t.id, subjectId: t.subjectId, ps });
      });
    });

    // Applica vincolo max N materie/giorno con bump
    Object.keys(cal).sort().forEach(date => {
      const items = cal[date];
      const subs  = [...new Set(items.map(i => i.subjectId))];
      if (subs.length <= maxS) return;

      const ranked = [...subs].sort((a, b) => {
        const ap = Math.max(...items.filter(i=>i.subjectId===a).map(i=>i.ps));
        const bp = Math.max(...items.filter(i=>i.subjectId===b).map(i=>i.ps));
        return bp - ap;
      });
      const keep = new Set(ranked.slice(0, maxS));
      const ov   = items.filter(i => !keep.has(i.subjectId));
      cal[date]  = items.filter(i =>  keep.has(i.subjectId));

      // Bumpa l'overflow al giorno successivo disponibile
      ov.forEach(o => {
        for (let k = 1; k <= 60; k++) {
          const nd = DM.addDays(date, k);
          const ex = (cal[nd] || []);
          const es = new Set(ex.map(i => i.subjectId));
          if (!es.has(o.subjectId) && es.size < maxS) {
            (cal[nd] = cal[nd] || []).push(o);
            break;
          }
        }
      });
    });

    // Costruisce l'array finale di reviews
    const newRevs = [...kept];
    const seen    = new Set(kept.map(r => r.topicId + '|' + r.data));
    Object.entries(cal).forEach(([date, items]) => {
      items.forEach(it => {
        const key = it.topicId + '|' + date;
        if (seen.has(key)) return;
        seen.add(key);
        newRevs.push({ id: DM.uid(), topicId: it.topicId, subjectId: it.subjectId, data: date, done: false, ps: it.ps });
      });
    });
    DM.setReviews(newRevs);
  }

  /*
   * initTopic â€” chiamato quando un topic viene creato senza sessioni pregresse.
   * Genera un piano iniziale usando la difficoltÃ  strutturale (scala 1â€“5 â†’ 1â€“10).
   */
  function initTopic(topicId) {
    const t = DM.getTopic(topicId); if (!t) return;
    const s = DM.getSubject(t.subjectId);
    // Converti difficoltÃ  1â€“5 in scala 1â€“10
    const diff10 = Math.round(((t.difficolta || 3) - 1) / 4 * 9) + 1;
    const plan   = AE.generatePlan(diff10, s ? s.dataEsame : null, DM.todayStr(), 0);
    t.reviewPlan          = plan;
    t.nextRev             = plan[0] || null;
    t.difficoltaPercepita = diff10;
    t.intervalloCorrente  = plan.length > 0
      ? Math.max(1, Math.round((new Date(plan[0]+'T00:00:00') - new Date(DM.todayStr()+'T00:00:00')) / 86400000))
      : 0;
    t.statoMemoria     = AE.calcMemoryState(t);
    t.prioritaCalcolata= AE.calcPriority(t, s);
    DM.updateTopic(topicId, t);
  }

  function getWeekLoad(n = 7) {
    const td = DM.todayStr();
    const res = [];
    for (let i = 0; i < n; i++) {
      const d    = DM.addDays(td, i);
      const revs = DM.getRevsByDate(d);
      res.push({ date: d, load: AE.calcDayLoad(revs), count: revs.length });
    }
    return res;
  }

  return { build, initTopic, getWeekLoad };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 4 â€” SimulationEngine
   Previsione rischio pre-esame con SRS adattivo
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Sim = (() => {

  function simSubject(subject) {
    const dte    = DM.daysUntil(subject.dataEsame);
    const topics = DM.getTopics(subject.id);
    if (!topics.length) return { subject, risk:0, level:'low', instabili:0, topicRisks:[], daysLeft:dte };

    const topicRisks = topics.map(t => {
      const d10   = t.difficoltaPercepita || t.difficolta * 2 || 5;
      const done  = t.numeroRipassi || 0;
      // Simula piano futuro con generatePlan
      const plan  = AE.generatePlan(d10, subject.dataEsame, DM.todayStr(), done);
      const totalExpected = done + plan.length;
      const target        = AE.targetReviews(d10);
      const pctComplete   = Math.min(1, totalExpected / target);

      // Stima stato finale dopo tutti i ripassi simulati
      const simTopic = { ...t, numeroRipassi: totalExpected, difficoltaPercepita: d10 };
      const finalState = AE.calcMemoryState(simTopic);
      const riskScore  = { consolidato:0.04, consolidamento:0.35, instabile:0.90 }[finalState] || 0.90;
      return { topic:t, riskScore, finalState, planLen:plan.length, pctComplete };
    });

    const instabili  = topicRisks.filter(r=>r.finalState==='instabile').length;
    const avgRisk    = topicRisks.reduce((a,r)=>a+r.riskScore,0) / topicRisks.length;
    const timePenalty= dte<7 ? 0.25 : dte<14 ? 0.10 : 0;
    const risk       = Math.min(1, avgRisk + timePenalty);
    const level      = risk < 0.25 ? 'low' : risk < 0.58 ? 'medium' : 'high';
    return { subject, risk, level, instabili, topicRisks, daysLeft:dte };
  }

  function runAll() {
    return DM.getSubjects()
      .filter(s => s.dataEsame)
      .sort((a,b) => DM.daysUntil(a.dataEsame) - DM.daysUntil(b.dataEsame))
      .map(s => simSubject(s));
  }

  return { simSubject, runAll };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 5 â€” StatisticsModule
   Ore di studio Â· trend Â· streak Â· per materia/argomento
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Stats = (() => {

  /* Filtra sessioni per topic attivi */
  function _activeSess() {
    const ids = new Set(DM.getAllTopics().map(t => t.id));
    return DM.getSessions().filter(s => ids.has(s.idArgomento));
  }

  /* Sessioni nell'intervallo [fromDate, toDate] (stringhe YYYY-MM-DD) */
  function _sessInRange(from, to) {
    return _activeSess().filter(s => s.data >= from && s.data <= to);
  }

  /* Minuti totali in una lista di sessioni */
  function _mins(sessions) {
    return sessions.reduce((a, s) => a + (s.durataEffettiva || 0), 0);
  }

  /* Ore formattate */
  function fmtOre(mins) {
    if (mins <= 0) return '0m';
    if (mins < 60) return mins + 'm';
    const h = Math.floor(mins / 60), m = mins % 60;
    return h + 'h' + (m ? ' ' + m + 'm' : '');
  }

  /* Ultimi N giorni come YYYY-MM-DD */
  function _lastNDays(n) {
    const res = [];
    for (let i = n - 1; i >= 0; i--) {
      const d = new Date(); d.setDate(d.getDate() - i);
      res.push(d.toISOString().slice(0, 10));
    }
    return res;
  }

  /* â”€â”€ API pubblica â”€â”€ */

  const weeklyMins = () => {
    const days = _lastNDays(7);
    return _mins(_sessInRange(days[0], days[6]));
  };

  const monthlyMins = () => {
    const days = _lastNDays(30);
    return _mins(_sessInRange(days[0], days[29]));
  };

  const totalMins = () => _mins(_activeSess());

  const totalSess = () => _activeSess().length;

  const completedRev = () => DM.getReviews().filter(r => r.done).length;

  const streak = () => {
    const sess = _activeSess();
    let s = 0;
    const d = new Date(); d.setHours(0, 0, 0, 0);
    while (true) {
      const ds = d.toISOString().slice(0, 10);
      if (sess.some(x => x.data === ds)) { s++; d.setDate(d.getDate() - 1); }
      else break;
    }
    return s;
  };

  /* Ultimi 7 giorni: { date, mins, count, dow } */
  const last7 = () => {
    const sess = _activeSess();
    return _lastNDays(7).map(ds => {
      const day = sess.filter(s => s.data === ds);
      const dow = ['D','L','M','M','G','V','S'][new Date(ds+'T00:00:00').getDay()];
      return { date: ds, mins: _mins(day), count: day.length, dow };
    });
  };

  /* Ultimi 30 giorni: { date, mins, count } */
  const last30 = () => {
    const sess = _activeSess();
    return _lastNDays(30).map(ds => {
      const day = sess.filter(s => s.data === ds);
      return { date: ds, mins: _mins(day), count: day.length };
    });
  };

  /* Ore per materia (tutte le sessioni) */
  const minsPerSubject = () => {
    const sess = _activeSess();
    return DM.getSubjects().map(sub => {
      const subTopics = new Set(DM.getTopics(sub.id).map(t => t.id));
      const subSess   = sess.filter(s => subTopics.has(s.idArgomento));
      return { subject: sub, mins: _mins(subSess), count: subSess.length };
    }).sort((a, b) => b.mins - a.mins);
  };

  /* Ore per argomento foglia (top N per ore) */
  const minsPerTopic = (n) => {
    const sess = _activeSess();
    return DM.getAllTopics()
      .filter(t => DM.getChildren(t.id).length === 0)
      .map(t => {
        const tSess = sess.filter(s => s.idArgomento === t.id);
        return { topic: t, mins: _mins(tSess), count: tSess.length };
      })
      .sort((a, b) => b.mins - a.mins)
      .slice(0, n || 10);
  };

  /* Ore settimanali per materia (ultimi 7gg) */
  const weeklyMinsPerSubject = () => {
    const days = _lastNDays(7);
    const sess = _sessInRange(days[0], days[6]);
    return DM.getSubjects().map(sub => {
      const subTopics = new Set(DM.getTopics(sub.id).map(t => t.id));
      return { subject: sub, mins: _mins(sess.filter(s => subTopics.has(s.idArgomento))) };
    }).filter(x => x.mins > 0).sort((a, b) => b.mins - a.mins);
  };

  /* Minuti studiati in un dato giorno */
  const minsOnDay = (ds) => _mins(_activeSess().filter(s => s.data === ds));

  const cfuDist = () => {
    const tot = DM.getSubjects().reduce((a, s) => a + (s.cfu || 6), 0);
    return DM.getSubjects().map(s => ({ subject: s, pct: tot ? Math.round((s.cfu || 6) / tot * 100) : 0 }));
  };

  const diffPerSubj = () => DM.getSubjects().map(s => {
    const tps = DM.getTopics(s.id);
    return { subject: s, avg: tps.length ? tps.reduce((a, t) => a + (t.difficolta || 3), 0) / tps.length : 0 };
  });

  const recentSess = (n) => [..._activeSess()].reverse().slice(0, n || 12);


  /* â”€â”€ Settimana corrente: lunedÃ¬â€“domenica contenente oggi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function currentWeekKey() {
    const now = new Date(); now.setHours(0,0,0,0);
    const dow = now.getDay() === 0 ? 6 : now.getDay() - 1; // lun=0
    const mon = new Date(now); mon.setDate(now.getDate() - dow);
    return mon.toISOString().slice(0, 10); // chiave = data del lunedÃ¬
  }

  function weekRange(monStr) {
    const mon = new Date(monStr + 'T00:00:00');
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    return { from: monStr, to: sun.toISOString().slice(0, 10) };
  }

  /* Minuti studiati in una settimana (lunedÃ¬ monStr) */
  function weekMins(monStr) {
    const { from, to } = weekRange(monStr);
    return _mins(_sessInRange(from, to));
  }

  /* Minuti per materia in una settimana */
  function weekMinsPerSubj(monStr) {
    const { from, to } = weekRange(monStr);
    const sess = _sessInRange(from, to);
    return DM.getSubjects().map(sub => {
      const ids = new Set(DM.getTopics(sub.id).map(t => t.id));
      return { subject: sub, mins: _mins(sess.filter(s => ids.has(s.idArgomento))) };
    }).filter(x => x.mins > 0);
  }

  /* Ripassi completati in una settimana */
  function weekRevsDone(monStr) {
    const { from, to } = weekRange(monStr);
    return DM.getReviews().filter(r => r.done && r.doneAt >= from && r.doneAt <= to).length;
  }

  /* Ultime N settimane (chiavi lunedÃ¬) ordinate dalla piÃ¹ recente */
  function lastNWeekKeys(n) {
    const keys = [];
    const now = new Date(); now.setHours(0, 0, 0, 0);
    const dow = now.getDay() === 0 ? 6 : now.getDay() - 1;
    const mon = new Date(now); mon.setDate(now.getDate() - dow);
    for (let i = 0; i < n; i++) {
      keys.push(mon.toISOString().slice(0, 10));
      mon.setDate(mon.getDate() - 7);
    }
    return keys;
  }

  /* Dati completi di una settimana (per storico + confronto) */
  function weekSnapshot(monStr) {
    const goal = DM.getPrefs().weeklyGoalMins || 600;
    const mins = weekMins(monStr);
    const revs = weekRevsDone(monStr);
    const bySubj = weekMinsPerSubj(monStr);
    const goalReached = mins >= goal;
    const { from, to } = weekRange(monStr);
    return { weekKey: monStr, from, to, mins, revs, goalReached, bySubj, goal };
  }

  /* Confronto settimana corrente vs precedente */
  function weekComparison() {
    const keys = lastNWeekKeys(2);
    const curr = weekSnapshot(keys[0]);
    const prev = keys[1] ? weekSnapshot(keys[1]) : null;
    const diff = prev ? curr.mins - prev.mins : null;
    return { curr, prev, diff };
  }

  /* Top 3 settimane per ore (da storico + settimana corrente) */
  function topWeeks() {
    const logs = DM.getWeeklyLogs();
    const currKey = currentWeekKey();
    // Aggiungi settimana corrente (non ancora loggata) se ha ore
    const currSnap = weekSnapshot(currKey);
    const all = [...logs];
    if (!all.find(l => l.weekKey === currKey) && currSnap.mins > 0) {
      all.push({ ...currSnap, isCurrent: true });
    }
    return all
      .filter(w => w.mins > 0)
      .sort((a, b) => b.mins - a.mins)
      .slice(0, 3);
  }

  /* Messaggio motivazionale */
  function motivMsg(comparison) {
    const { curr, prev, diff } = comparison;
    const goal = curr.goal;
    if (curr.goalReached && (!prev || !prev.goalReached))
      return { icon: 'ğŸŒŸ', text: 'Hai raggiunto il tuo obiettivo settimanale!', color: 'var(--green)' };
    if (diff === null)
      return curr.mins > 0
        ? { icon: 'â–¶', text: 'Prima settimana registrata. Ottimo inizio!', color: 'var(--amber)' }
        : null;
    if (diff > 0) {
      const top = topWeeks();
      if (top.length > 0 && curr.mins >= top[0].mins)
        return { icon: 'ğŸ†', text: 'Hai battuto il tuo record settimanale!', color: 'var(--green)' };
      return { icon: 'â†‘', text: 'Hai studiato ' + fmtOre(Math.abs(diff)) + ' in piÃ¹ rispetto alla scorsa settimana.', color: 'var(--green)' };
    }
    if (diff < 0)
      return { icon: 'â†“', text: 'Hai studiato ' + fmtOre(Math.abs(diff)) + ' in meno rispetto alla scorsa settimana.', color: 'var(--amber)' };
    return { icon: 'â†’', text: 'Stesso ritmo della settimana scorsa. Mantieni la costanza!', color: 'var(--ink3)' };
  }

  return { weeklyMins, monthlyMins, totalMins, totalSess, completedRev, streak,
           last7, last30, minsPerSubject, minsPerTopic, weeklyMinsPerSubject,
           minsOnDay, cfuDist, diffPerSubj, recentSess, fmtOre,
           currentWeekKey, weekRange, weekMins, weekMinsPerSubj, weekRevsDone,
           lastNWeekKeys, weekSnapshot, weekComparison, topWeeks, motivMsg };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 6 â€” ExportImportManager
   JSON backup / restore
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EIM = (() => {
  function exportJSON() {
    const blob=new Blob([DM.exportAll()],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='studyplan_'+new Date().toISOString().slice(0,10)+'.json';
    a.click(); URL.revokeObjectURL(a.href);
    UI.toast('Dati esportati.');
  }
  function importJSON(input) {
    const file=input.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        DM.importAll(e.target.result);
        AE.refreshAll(); Sched.build();
        UI.goto('home'); UI.toast('Dati importati.');
      } catch(err){ UI.toast('Errore nel file JSON.'); }
    };
    reader.readAsText(file); input.value='';
  }
  return { exportJSON, importJSON };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE 7 â€” UIController
   Routing Â· rendering Â· timer Â· overlays Â· toast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const UI = (() => {
  let curPage='home', sideOpen=true;
  let calMode='month', calDate=new Date();
  let _eSId=null, _eTId=null, _moveTId=null, _cfCb=null;
  let _wkMode='ore'; // ore | materia | revs
  let _toastTm, _undoTm, _undoCb;
  // â”€â”€ Timer State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TS={
    topicId:null, running:false, secs:0, total:0, iv:null, start:null, diff:3,
    mode:'countdown',       // 'countdown' | 'free'
    phase:'study',          // 'study' | 'break'
    sessionIdx:0,           // sessione corrente (0-based)
    totalSessions:1,        // sessioni totali configurate
    study:25, brk:5,        // minuti studio/pausa
    freeElapsed:0,          // secondi nel timer libero
    studyMinsAccum:0        // minuti studio accumulati nelle fasi studio (per free+multi-session)
  };

  const $  = id => document.getElementById(id);
  const ha = (hex,a) => { try{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;}catch(e){return`rgba(200,160,60,${a})`;} };
  const df = d => ['','â˜…','â˜…â˜…','â˜…â˜…â˜…','â˜…â˜…â˜…â˜…','â˜…â˜…â˜…â˜…â˜…'][Math.min(5,Math.max(1,Math.round(d)))]||'';
  const memB = st => {
    const cls={instabile:'mem-instabile',consolidamento:'mem-consolidamento',consolidato:'mem-consolidato'}[st]||'b-def';
    const lbl={instabile:'Instabile',consolidamento:'In consolidamento',consolidato:'Consolidato'}[st]||st;
    return '<span class="badge '+cls+'">'+lbl+'</span>';
  };

  const PAGE_TITLES = {home:'Dashboard',materie:'Materie',studia:'Studia',calendario:'Calendario',simulazione:'Simulazione',statistiche:'Statistiche',classifica:'Classifica',impostazioni:'Impostazioni'};

  /* â”€â”€ SIDEBAR â”€â”€ */
  function toggleSidebar() {
    sideOpen=!sideOpen;
    $('sidebar').classList.toggle('closed',!sideOpen);
    // heartToggle: non serve piÃ¹ gestirlo, la mini sidebar Ã¨ sempre visibile
    const ht=$('heartToggle');
    if(ht) ht.style.display='none';
  }

  /* â”€â”€ NAVIGATION â”€â”€ */
  function goto(id) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const pg=$('page-'+id); if(pg) pg.classList.add('active');
    const nb=$('nav-'+id);  if(nb) nb.classList.add('active');
    $('topTitle').textContent = PAGE_TITLES[id]||id;
    const tr=$('topRight'); tr.innerHTML='';
    if(id==='materie') tr.innerHTML='<button class="btn btn-primary btn-sm" onclick="UI.openAddSubj()">+ Materia</button>';
    curPage=id;
    const render={home:renderHome,materie:renderMaterie,studia:renderStudia,calendario:renderCal,simulazione:renderSim,statistiche:renderStats,classifica:renderClassifica,impostazioni:renderImpost};
    if(id!=='home' && typeof _homeClock!=='undefined' && _homeClock){ clearInterval(_homeClock); _homeClock=null; }
    if(render[id]) render[id]();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* toggleBlock â€” espande/chiude un blocco nella home */
  function toggleBlock(bodyId, chevId){
    const body=$(bodyId), chev=$(chevId);
    if(!body) return;
    const isOpen=body.style.display!=='none';
    body.style.display=isOpen?'none':'';
    if(chev) chev.classList.toggle('open',!isOpen);
  }

  /* _homeClockTick â€” aggiorna ora ogni secondo */
  let _homeClock=null;
  function _startHomeClock(){
    if(_homeClock) clearInterval(_homeClock);
    function tick(){
      const now=new Date();
      const timeStr=now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      if($('hTimeTxt')) $('hTimeTxt').textContent=timeStr;
    }
    tick();
    _homeClock=setInterval(tick,1000);
  }

  /* _hGreet â€” saluto dinamico con fascia oraria */
  function _hGreet(h, nome){
    let base;
    if(h>=5&&h<12)       base='Buongiorno';
    else if(h>=12&&h<18) base='Buon pomeriggio';
    else if(h>=18&&h<22) base='Buonasera';
    else                 base='Buonanotte';
    return nome ? base+', '+nome : base;
  }

  /* _buildStudyItems â€” argomenti con prossimo ripasso oggi o mai studiati */
  function _buildStudyItems(td){
    const allLeaf=DM.getAllTopics().filter(t=>DM.getChildren(t.id).length===0&&!t.del);
    // "nuovo": nessuna sessione registrata
    const newTopics=allLeaf.filter(t=>!(t.numeroRipassi>0)&&!t.nextRev);
    return newTopics;
  }

  /* _renderHomeStudy â€” blocco argomenti nuovi */
  function _renderHomeStudy(){
    const td=DM.todayStr();
    const items=_buildStudyItems(td);
    const meta=$('hStudyMeta');
    if(meta) meta.textContent=items.length?'('+items.length+')':'';
    const body=$('hStudyBody');
    if(!body) return;
    if(!items.length){
      body.innerHTML='<div style="padding:14px 16px;font-size:13px;color:var(--ink3);">Tutti gli argomenti hanno giÃ  almeno una sessione registrata. Ottimo!</div>';
      return;
    }
    // Raggruppa per materia
    const bySub={};
    items.forEach(t=>{
      (bySub[t.subjectId]=bySub[t.subjectId]||[]).push(t);
    });
    body.innerHTML=Object.entries(bySub).map(([sid,topics])=>{
      const s=DM.getSubject(sid); if(!s) return '';
      return topics.map(t=>{
        const eid='hsi_'+t.id;
        const children=DM.getTopics(s.id).filter(c=>c.parentId===t.id&&!c.del);
        const hasSub=children.length>0;
        return '<div class="h-item" onclick="UI._hToggleStudyItem(\''+t.id+'\',\''+eid+'\')">' +
          '<div class="h-item-dot" style="background:'+s.colore+';margin-top:6px;"></div>'+
          '<div class="h-item-main">'+
            '<div class="h-item-title">'+s.nome+' <span style="color:var(--ink3);">â€º</span> <strong>'+t.titolo+'</strong>'+(hasSub?' <span style="font-size:10px;color:var(--ink3);">('+children.length+' sotto)</span>':'')+'</div>'+
            (t.dataUltimoRipasso?'':'<div class="h-item-sub">Mai studiato</div>')+
          '</div>'+
          '<div class="h-item-act">'+
            '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation();UI.startTimer(\''+t.id+'\');UI.goto(\'studia\')">â–¶</button>'+
          '</div>'+
        '</div>'+
        '<div id="'+eid+'" style="display:none;">'+
          (hasSub
            ? '<div class="h-item-expand">'+children.map(ch=>'<div style="font-size:12.5px;color:var(--ink2);padding:3px 0;display:flex;align-items:center;gap:8px;"><span style="color:var(--ink3);">â””</span>'+ch.titolo+'<button class="btn btn-xs btn-ghost" onclick="UI.startTimer(\''+ch.id+'\');UI.goto(\'studia\')" style="margin-left:auto;">â–¶</button></div>').join('')+'</div>'
            : '')+
        '</div>';
      }).join('');
    }).join('');
  }

  /* _hToggleStudyItem */
  function _hToggleStudyItem(tid, eid){
    const el=$(eid); if(!el) return;
    el.style.display=el.style.display==='none'?'':'none';
  }

  /* _renderHomeRevs â€” blocco ripassi */
  function _renderHomeRevs(){
    const td=DM.todayStr();
    const revs=DM.getRevsByDate(td).filter(r=>!r.done);
    const meta=$('hRevMeta');
    if(meta) meta.textContent=revs.length?'('+revs.length+')':'';
    const body=$('hRevBody');
    if(!body) return;
    if(!revs.length){
      body.innerHTML='<div style="padding:14px 16px;font-size:13px;color:var(--ink3);">Nessun ripasso pianificato per oggi. âœ“</div>';
      return;
    }
    // Raggruppa per materia
    const bySub={};
    revs.forEach(r=>(bySub[r.subjectId]=bySub[r.subjectId]||[]).push(r));
    body.innerHTML=Object.entries(bySub).map(([sid,rs])=>{
      const s=DM.getSubject(sid); if(!s) return '';
      return rs.map(r=>{
        const t=DM.getTopic(r.topicId); if(!t) return '';
        const stab=_topicStability(t);
        const barCol=stab>=70?'var(--green)':stab>=35?'var(--amber)':'var(--red)';
        const sc=r.snoozeCount||0;
        const eid='hri_'+r.id;
        const children=DM.getTopics(s.id).filter(c=>c.parentId===t.id&&!c.del);
        return '<div class="h-item" onclick="UI._hToggleStudyItem(\''+r.id+'\',\''+eid+'\')">' +
          '<div class="h-item-dot" style="background:'+s.colore+';margin-top:6px;"></div>'+
          '<div class="h-item-main">'+
            '<div class="h-item-title">'+s.nome+' <span style="color:var(--ink3);">â€º</span> <strong>'+t.titolo+'</strong>'+
              (sc>0?'<span style="font-size:10px;color:var(--red);margin-left:4px;">rimandato '+sc+'Ã—</span>':'')+
            '</div>'+
            '<div class="h-item-sub" style="display:flex;align-items:center;gap:6px;margin-top:3px;">'+
              '<div style="width:48px;height:2px;background:var(--line);border-radius:99px;overflow:hidden;display:inline-block;">'+
                '<div style="height:100%;width:'+stab+'%;background:'+barCol+';border-radius:99px;"></div></div>'+
              '<span>StabilitÃ  '+stab+'%</span>'+
            '</div>'+
          '</div>'+
          '<div class="h-item-act">'+
            '<button class="btn btn-xs btn-ghost" onclick="event.stopPropagation();UI.snoozeReview(\''+r.id+'\',\''+t.id+'\')" title="Rimanda">ğŸ˜®â€ğŸ’¨</button>'+
            '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation();UI.startTimer(\''+t.id+'\');UI.goto(\'studia\')">â–¶</button>'+
          '</div>'+
        '</div>'+
        '<div id="'+eid+'" style="display:none;">'+
          '<div class="h-item-expand">'+
            '<div style="font-size:12px;color:var(--ink3);margin-bottom:6px;">'+
              (t.reviewPlan&&t.reviewPlan.length?t.reviewPlan.length+' ripassi futuri pianificati':'Piano completato')+
              (t.dataUltimoRipasso?' Â· Ultimo ripasso: '+t.dataUltimoRipasso:'')+
            '</div>'+
            (children.length?'<div style="font-size:12px;color:var(--ink2);">Sotto-argomenti: '+children.map(ch=>ch.titolo).join(', ')+'</div>':'')+
          '</div>'+
        '</div>';
      }).join('');
    }).join('');
  }

  /* _renderHomeExams â€” blocco esami */
  function _renderHomeExams(){
    const allSubj=DM.getSubjects().filter(s=>s.dataEsame);
    const future=allSubj
      .map(s=>({s,dte:DM.daysUntil(s.dataEsame)}))
      .filter(x=>x.dte>=0)
      .sort((a,b)=>a.dte-b.dte);
    const kpi=$('hKpiExams');
    if(kpi) kpi.textContent=future.length;
    const meta=$('hExamsMeta');
    if(meta) meta.textContent=future.length?'('+future.length+')':'';
    const body=$('hExamsBody');
    if(!body) return;
    if(!future.length){
      body.innerHTML='<div style="padding:14px 16px;font-size:13px;color:var(--ink3);">Nessun esame futuro registrato.</div>';
      return;
    }
    body.innerHTML=future.map(({s,dte},i)=>{
      const eid='hex_'+s.id;
      const dateStr=new Date(s.dataEsame+'T00:00:00').toLocaleDateString('it-IT',{day:'numeric',month:'long',year:'numeric'});
      const urgCol=dte<=7?'var(--red)':dte<=14?'var(--amber)':'var(--green)';
      const pending=DM.getReviews().filter(r=>!r.done&&r.subjectId===s.id).length;
      const topics=DM.getTopics(s.id);
      const done=topics.filter(t=>t.statoMemoria==='consolidato').length;
      const pct=topics.length?Math.round(done/topics.length*100):0;
      // Sotto-riquadro dettaglio (inizialmente nascosto)
      const detailHtml='<div class="h-exam-detail" id="'+eid+'" style="display:none;">'+
        '<div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:10px;">'+
          '<div><div style="font-size:11px;color:var(--ink3);">Consolidamento</div>'+
            '<div style="font-size:13px;font-weight:600;color:var(--ink);">'+pct+'% ('+done+'/'+topics.length+')</div></div>'+
          '<div><div style="font-size:11px;color:var(--ink3);">Ripassi rimasti</div>'+
            '<div style="font-size:13px;font-weight:600;color:'+(pending>0?'var(--amber)':'var(--green)')+';">'+
              (pending>0?pending:'\u2713 Tutti fatti')+'</div></div>'+
          '<div><div style="font-size:11px;color:var(--ink3);">CFU</div>'+
            '<div style="font-size:13px;font-weight:600;color:var(--ink);">'+(s.cfu||'?')+'</div></div>'+
        '</div>'+
        (topics.length
          ? '<div style="font-size:11.5px;color:var(--ink3);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;">Argomenti</div>'+
            '<div style="display:flex;flex-direction:column;gap:3px;">'+
            topics.slice(0,8).map(t=>{
              const stab=_topicStability(t);
              const bc=stab>=70?'var(--green)':stab>=35?'var(--amber)':'var(--red)';
              return '<div style="display:flex;align-items:center;gap:8px;font-size:12.5px;color:var(--ink2);">'+
                '<div style="width:3px;height:3px;border-radius:50%;background:'+s.colore+';flex-shrink:0;"></div>'+
                t.titolo+
                '<div style="margin-left:auto;width:36px;height:2px;background:var(--line);border-radius:99px;overflow:hidden;">'+
                  '<div style="height:100%;width:'+stab+'%;background:'+bc+'"></div></div></div>';
            }).join('')+
            (topics.length>8?'<div style="font-size:11.5px;color:var(--ink3);margin-top:4px;">...e altri '+(topics.length-8)+'</div>':'')
          : '<div style="font-size:12px;color:var(--ink3);">Nessun argomento registrato.</div>')+
        '</div>'+
        '<button class="btn btn-sm" style="margin-top:10px;" onclick="UI.goto(\'materie\')">Vai alla materia â†’</button>'+
        '</div>';

      return '<div class="h-exam-row" onclick="UI._hToggleExam(\''+eid+'\',this.querySelector(\'.h-exam-chev\'))">'+
        '<div class="h-exam-rank">'+(i+1)+'</div>'+
        '<div class="h-exam-color" style="background:'+s.colore+';"></div>'+
        '<div class="h-exam-body">'+
          '<div class="h-exam-name">'+s.nome+'</div>'+
          '<div class="h-exam-date" style="color:'+urgCol+';">'+dateStr+
            ' Â· '+(dte===0?'OGGI':dte===1?'domani':'tra '+dte+' giorni')+
          '</div>'+
        '</div>'+
        '<span class="h-exam-chev">â–¶</span>'+
        '</div>'+
        detailHtml;
    }).join('');
  }

  function _hToggleExam(eid, chevEl){
    const el=$(eid); if(!el) return;
    const isOpen=el.style.display!=='none';
    el.style.display=isOpen?'none':'';
    if(chevEl) chevEl.classList.toggle('open',!isOpen);
  }

  function renderHome() {
    const now=new Date(), h=now.getHours(), p=DM.getPrefs();

    // â‘  Saluto + clock
    const greet=_hGreet(h, p.name||'');
    if($('hGreet')) $('hGreet').textContent=greet;
    if($('hDateTxt')) $('hDateTxt').textContent=now.toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    _startHomeClock();

    // â‘¡ KPI
    const td=DM.todayStr();
    const todayRevs=DM.getRevsByDate(td);
    const activeSubjIds=new Set(DM.getSubjects().map(s=>s.id));
    const inst=DM.getAllTopics().filter(t=>t.statoMemoria==='instabile'&&activeSubjIds.has(t.subjectId)).length;
    const todayMins=Stats.minsOnDay(td);
    if($('hKpiOre'))  $('hKpiOre').textContent=Stats.fmtOre(todayMins)||'â€”';
    if($('hKpiRev'))  $('hKpiRev').textContent=todayRevs.filter(r=>!r.done).length;
    if($('hKpiInst')) $('hKpiInst').textContent=inst;

    // Goal bar
    const wMinsH=Stats.weeklyMins(), goalH=p.weeklyGoalMins||600;
    const goalPctH=Math.min(100,Math.round(wMinsH/goalH*100));
    if($('hOreWGoal')) $('hOreWGoal').textContent=Stats.fmtOre(wMinsH)+' / '+Stats.fmtOre(goalH);
    if($('hOreWBar'))  $('hOreWBar').style.width=goalPctH+'%';
    if($('hOreWBar'))  $('hOreWBar').style.background=goalPctH>=100?'var(--green)':goalPctH>=60?'var(--amber)':'var(--red)';

    // â‘¢ Argomenti
    _renderHomeStudy();
    // â‘£ Ripassi
    _renderHomeRevs();
    // â‘¤ Esami
    _renderHomeExams();

    // â‘¥ Carico 7gg
    const wl=Sched.getWeekLoad(7), mx=Math.max(...wl.map(d=>d.load),0.01);
    $('loadChart').innerHTML=wl.map((d,i)=>{
      const hh=Math.max(4,Math.round(d.load/mx*52));
      const col=d.load<0.3?'var(--green)':d.load<0.65?'var(--amber)':'var(--red)';
      return '<div class="load-seg" style="height:'+hh+'px;background:'+(i===0?'var(--ink)':col)+';opacity:'+(i===0?1:0.72)+';" title="'+d.count+' sessioni Â· carico '+Math.round(d.load*100)+'%"></div>';
    }).join('');
    const DNS=['D','L','M','M','G','V','S'];
    $('loadLabels').innerHTML=wl.map((d,i)=>'<div class="load-lbl" style="'+(i===0?'color:var(--ink);font-weight:600;':'')+'">'+DNS[new Date(d.date+'T00:00:00').getDay()]+'</div>').join('');

    // Badge studia
    const bc=todayRevs.filter(r=>!r.done).length;
    const be=$('badgeStudia'); if(be){if(bc>0){be.textContent=bc;be.style.display='inline';}else be.style.display='none';}

    // Backward-compat ids
    if($('hOggi'))   $('hOggi').textContent=todayRevs.length;
    if($('hInst'))   $('hInst').textContent=inst;
    if($('hOreOggi'))$('hOreOggi').textContent=Stats.fmtOre(todayMins)||'â€”';
  }
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MATERIE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderMaterie() {
    const subs=DM.getSubjects(), list=$('materieList'), emp=$('materieEmpty');
    if(!subs.length){list.innerHTML='';emp.style.display='block';return;}
    emp.style.display='none';
    list.innerHTML=subs.map(s=>_subjCard(s)).join('');
  }
  function _subjCard(s) {
    const dte=s.dataEsame?DM.daysUntil(s.dataEsame):null;
    const eB=dte!==null?'<span class="badge '+(dte<0?'b-red':dte<14?'b-amber':'b-green')+'">'+(dte>=0?'Esame tra '+dte+' gg':'Passato')+'</span>':'';
    const tps=DM.getTopics(s.id), done=tps.filter(t=>t.statoMemoria==='consolidato').length;
    const pct=tps.length?Math.round(done/tps.length*100):0;
    return '<div class="subj-card">'+
      '<div class="subj-head" onclick="UI.togAcc(\'sacc_'+s.id+'\',\'schev_'+s.id+'\')">'+
      '<div class="dot" style="background:'+s.colore+';width:10px;height:10px;"></div>'+
      '<div style="flex:1;"><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span style="font-weight:600;font-size:14px;">'+s.nome+'</span><span class="badge b-def">'+(s.cfu||'?')+' CFU</span>'+eB+'</div>'+
      '<div class="prog" style="width:140px;margin-top:5px;"><div class="prog-bar" style="background:'+s.colore+';width:'+pct+'%;"></div></div>'+
      '<div style="font-size:11px;color:var(--ink3);margin-top:2px;">'+pct+'% consolidato Â· '+tps.length+' argomenti</div></div>'+
      '<div style="display:flex;gap:3px;opacity:.55;">'+
      '<button class="btn btn-ghost btn-xs btn-icon" onclick="event.stopPropagation();UI.openAddTopic(\''+s.id+'\')" title="+">+</button>'+
      '<button class="btn btn-ghost btn-xs btn-icon" onclick="event.stopPropagation();UI.editSubj(\''+s.id+'\')" title="âœ">âœ</button>'+
      '<button class="btn btn-ghost btn-xs btn-icon" style="color:var(--red)" onclick="event.stopPropagation();UI.archSubj(\''+s.id+'\')" title="âœ•">âœ•</button>'+
      '</div><span class="chev" id="schev_'+s.id+'">â–¶</span></div>'+
      '<div id="sacc_'+s.id+'" style="display:none;"><div class="subj-body">'+
      _topicTree(s.id,null,0)+
      '<button class="btn btn-ghost btn-sm" style="margin-top:10px;" onclick="UI.openAddTopic(\''+s.id+'\')">+ Aggiungi argomento</button>'+
      '</div></div></div>';
  }
  /*
   * _topicStability â€” stabilitÃ  della memoria [0â€“100]
   * Basata su: numero ripassi fatti, difficoltÃ  percepita, tempo dall'ultimo ripasso.
   * 0   = instabile (rosso)
   * 35  = media (giallo)
   * 70+ = consolidato (verde)
   */
  function _topicStability(t) {
    const n    = t.numeroRipassi || 0;
    const d10  = t.difficoltaPercepita || (t.difficolta ? t.difficolta * 2 : 5);
    const plan = t.reviewPlan || [];
    // Base: ripassi fatti contribuiscono, difficoltÃ  alta penalizza
    const reviewScore = Math.min(100, n * 15);             // +15 per ripasso, max 100
    const diffPenalty = (d10 - 1) / 9 * 30;               // -0 a -30 per diff 1â€“10
    // Bonus piano completato (se reviewPlan esaurito)
    const planBonus = plan.length === 0 && n >= 3 ? 20 : 0;
    return Math.max(0, Math.min(100, Math.round(reviewScore - diffPenalty + planBonus)));
  }

  /*
   * _topicPriority â€” prioritÃ  di ripasso: 'high' | 'medium' | 'low'
   * Combina stabilitÃ  + urgenza esame.
   */
  function _topicPriority(t) {
    const stab = _topicStability(t);
    const s    = DM.getSubject(t.subjectId);
    const dte  = s && s.dataEsame ? DM.daysUntil(s.dataEsame) : 999;
    // Urgenza: lineare 0â€“1 (dte=0â†’1, dte=60+â†’0)
    const urg  = Math.max(0, 1 - dte / 60);
    // Score: bassa stabilitÃ  + alta urgenza = prioritÃ  alta
    const score = (1 - stab / 100) * 0.6 + urg * 0.4;
    if (score > 0.60) return 'high';
    if (score > 0.30) return 'medium';
    return 'low';
  }

  /*
   * _stabilityBar â€” restituisce HTML della barra di stabilitÃ  + icona prioritÃ 
   * @param t      topic object
   * @param opts   { width: '80px', height: '3px', showIcon: true }
   */
  function _stabilityBar(t, opts) {
    opts = opts || {};
    const w    = opts.width  || '80px';
    const h    = opts.height || '3px';
    const icon = opts.showIcon !== false;
    const stab = _topicStability(t);
    const prio = _topicPriority(t);
    const col  = stab >= 70 ? 'var(--green)' : stab >= 35 ? 'var(--amber)' : 'var(--red)';
    const prioDot = prio === 'high' ? '#DC2626' : prio === 'medium' ? '#D97706' : '#16A34A';
    return '<div style="display:flex;align-items:center;gap:6px;">'+
      (icon ? '<div title="PrioritÃ  '+(prio==='high'?'alta':prio==='medium'?'media':'bassa')+'" '+
        'style="width:7px;height:7px;border-radius:50%;background:'+prioDot+';flex-shrink:0;"></div>' : '')+
      '<div style="width:'+w+';height:'+h+';background:var(--line);border-radius:99px;overflow:hidden;flex-shrink:0;">'+
      '<div style="height:100%;width:'+stab+'%;background:'+col+';border-radius:99px;transition:width .5s;"></div>'+
      '</div>'+
      '</div>';
  }

  function _topicTree(subjectId, parentId, depth) {
    if (depth > 3) return '';
    const items = DM.getTopics(subjectId).filter(t => t.parentId === parentId);
    if (!items.length) return '';
    return items.map(t => {
      const kids    = DM.getChildren(t.id);
      const hasKids = kids.length > 0;
      const stab    = _topicStability(t);
      const prio    = _topicPriority(t);
      const barCol  = stab >= 70 ? 'var(--green)' : stab >= 35 ? 'var(--amber)' : 'var(--red)';
      const prioDot = prio === 'high' ? '#DC2626' : prio === 'medium' ? '#D97706' : '#16A34A';
      const d10     = t.difficoltaPercepita || (t.difficolta ? t.difficolta * 2 : 5);
      const metaParts = [
        (t.difficoltaPercepita ? 'diff ' + d10 + '/10' : 'diff ' + df(t.difficolta)),
        (t.numeroRipassi || 0) + ' ripasso' + ((t.numeroRipassi||0) !== 1 ? 'i' : '') + ' fatt' + ((t.numeroRipassi||0) !== 1 ? 'i' : 'o'),
        (t.reviewPlan && t.reviewPlan.length ? t.reviewPlan.length + ' in piano' : ''),
        (t.nextRev && !hasKids ? 'prossimo ' + t.nextRev : ''),
      ].filter(Boolean).join(' Â· ');
      const metaKids = hasKids ? ' &nbsp;<em style="color:var(--ink3);font-size:10.5px;">raggruppato</em>' : '';

      return '<div class="tree-item depth-' + depth + '" style="margin-left:' + (depth * 16) + 'px;">' +
        '<div class="tree-row" onclick="UI.togAcc(\'' + 'tacc_' + t.id + '\',\'' + 'tchev_' + t.id + '\')" style="cursor:' + (hasKids ? 'pointer' : 'default') + ';">' +
        '<div class="tree-main">' +
        '<div style="font-size:13.5px;font-weight:' + (hasKids ? '500' : '400') + ';">' + t.titolo + '</div>' +
        '<div style="display:flex;align-items:center;gap:8px;margin-top:3px;">' +
        '<div title="PrioritÃ  ' + (prio === 'high' ? 'alta' : prio === 'medium' ? 'media' : 'bassa') + '" style="width:7px;height:7px;border-radius:50%;background:' + prioDot + ';flex-shrink:0;"></div>' +
        '<div style="width:80px;height:3px;background:var(--line);border-radius:99px;overflow:hidden;flex-shrink:0;">' +
        '<div style="height:100%;width:' + stab + '%;background:' + barCol + ';border-radius:99px;transition:width .5s;"></div>' +
        '</div>' +
        '<div class="tree-meta">' + metaParts + metaKids + '</div>' +
        '</div>' +
        '</div>' +
        '<div class="tree-act">' +
        '<button class="btn btn-ghost btn-xs btn-icon" onclick="UI.startTimer(\'' + t.id + '\');UI.goto(\'studia\')" title="â–¶">â–¶</button>' +
        '<button class="btn btn-ghost btn-xs btn-icon" onclick="UI.openAddTopic(\'' + t.subjectId + '\',\'' + t.id + '\')" title="+">+</button>' +
        '<button class="btn btn-ghost btn-xs btn-icon" onclick="UI.editTopic(\'' + t.id + '\')" title="âœ">âœ</button>' +
        '<button class="btn btn-ghost btn-xs btn-icon" onclick="UI.openMove(\'' + t.id + '\')" title="â‡„">â‡„</button>' +
        '<button class="btn btn-ghost btn-xs btn-icon" style="color:var(--red)" onclick="UI.delTopic(\'' + t.id + '\')" title="âœ•">âœ•</button>' +
        '</div>' +
        '<span class="chev" id="tchev_' + t.id + '" style="display:' + (hasKids ? 'inline' : 'none') + ';">â–¶</span>' +
        '</div>' +
        '<div id="tacc_' + t.id + '" style="display:none;">' + _topicTree(subjectId, t.id, depth + 1) + '</div>' +
        '</div>';
    }).join('');
  }
  function togAcc(bId,cId){const b=$(bId),c=$(cId);if(!b)return;const open=b.style.display!=='none';b.style.display=open?'none':'block';if(c)c.classList.toggle('open',!open);}

  /* SUBJECT CRUD */
  function openAddSubj(){_eSId=null;$('mSubjT').textContent='Nuova materia';$('fSName').value='';$('fSCFU').value='';$('fSExam').value='';$('fSColor').value='#D97706';openOv('ovSubj');}
  function editSubj(id){_eSId=id;const s=DM.getSubject(id);$('mSubjT').textContent='Modifica materia';$('fSName').value=s.nome;$('fSCFU').value=s.cfu||'';$('fSExam').value=s.dataEsame||'';$('fSColor').value=s.colore||'#D97706';openOv('ovSubj');}
  function saveSubj(){
    const nome=$('fSName').value.trim(); if(!nome){toast('Inserisci un nome.');return;}
    const data={nome,cfu:parseInt($('fSCFU').value)||6,dataEsame:$('fSExam').value||null,colore:$('fSColor').value};
    if(_eSId) DM.updateSubject(_eSId,data); else DM.addSubject(data);
    AE.refreshAll(); Sched.build(); closeOv('ovSubj'); renderMaterie(); toast(_eSId?'Materia aggiornata.':'Materia aggiunta.');
  }
  function archSubj(id){
    const s=DM.getSubject(id);
    if(!s){ toast('Materia non trovata.'); return; }
    // Usa il modal custom se disponibile, altrimenti confirm() nativo
    const doDelete = () => {
      DM.deleteSubject(id);
      AE.refreshAll();
      Sched.build();
      renderMaterie();
      renderHome();
      toast('Materia "'+s.nome+'" eliminata.');
    };
    const cfEl = $('cfBox');
    if(cfEl){
      cfConfirm(
        'Elimina "'+s.nome+'"?',
        'La materia, tutti i suoi argomenti, le sessioni e i ripassi verranno eliminati definitivamente.',
        doDelete
      );
    } else {
      if(window.confirm('Eliminare "'+s.nome+'" e tutti i suoi argomenti definitivamente?')){
        doDelete();
      }
    }
  }

  /* TOPIC CRUD */
  function _fillSubjSel(sid){$('fTSubj').innerHTML=DM.getSubjects().map(s=>'<option value="'+s.id+'" '+(s.id===sid?'selected':'')+'>'+s.nome+'</option>').join('');}
  function _fillParSel(sid,selId){
    $('fTParent').innerHTML='<option value="">â€” Nessuno (radice) â€”</option>'+
      DM.getAllTopics().filter(t=>t.subjectId===sid).map(t=>'<option value="'+t.id+'" '+(t.id===selId?'selected':'')+'>'+'&nbsp;'.repeat((t.livello||0)*3)+t.titolo+'</option>').join('');
  }
  function openAddTopic(sid,pid=null){
    _eTId=null;$('mTopicT').textContent='Nuovo argomento';$('fTTitle').value='';$('fTDiff').value=3;$('fTDV').textContent=3;$('fTLevel').value=pid?'1':'0';
    _fillSubjSel(sid);_fillParSel(sid,pid);$('fTSubj').onchange=()=>_fillParSel($('fTSubj').value,null);openOv('ovTopic');
  }
  function editTopic(id){
    _eTId=id;const t=DM.getTopic(id);$('mTopicT').textContent='Modifica argomento';$('fTTitle').value=t.titolo;$('fTDiff').value=t.difficolta||3;$('fTDV').textContent=t.difficolta||3;$('fTLevel').value=t.livello||0;
    _fillSubjSel(t.subjectId);_fillParSel(t.subjectId,t.parentId);$('fTSubj').onchange=()=>_fillParSel($('fTSubj').value,null);openOv('ovTopic');
  }
  function saveTopic(){
    const titolo=$('fTTitle').value.trim(); if(!titolo){toast('Inserisci un titolo.');return;}
    const data={titolo,subjectId:$('fTSubj').value,parentId:$('fTParent').value||null,livello:parseInt($('fTLevel').value)||0,difficolta:parseFloat($('fTDiff').value)||3};
    if(_eTId){
      DM.updateTopic(_eTId,data);
    } else {
      const t=DM.addTopic(data);
      // Inizializza il piano SRS (genera reviewPlan dal diff strutturale)
      Sched.initTopic(t.id);
      // Il padre non Ã¨ piÃ¹ foglia: rimuovi il suo piano dal calendario
      if(data.parentId){
        DM.updateTopic(data.parentId,{nextRev:null,intervalloCorrente:0,reviewPlan:[]});
      }
    }
    AE.refreshAll(); Sched.build(); closeOv('ovTopic'); renderMaterie(); toast(_eTId?'Argomento aggiornato.':'Argomento aggiunto.');
  }
  function delTopic(id){
    const t=DM.getTopic(id);
    DM.softDel(id);
    // Se il padre ora non ha piÃ¹ figli, torna foglia: rigenera il suo piano SRS
    if(t.parentId){
      const siblings=DM.getChildren(t.parentId);
      if(siblings.length===0){
        const parent=DM.getTopic(t.parentId);
        if(parent){ Sched.initTopic(parent.id); }
      }
    }
    AE.refreshAll(); Sched.build(); UI._applyTheme(); renderMaterie();
  // Mini sidebar: sempre visibile, nessuna gestione extra
    let committed=false;
    const commitTimer=setTimeout(()=>{
      if(!committed){committed=true;DM.hardDel(id);Sched.build();}
    },5000);
    toast('"'+t.titolo+'" eliminato.',()=>{
      committed=true;clearTimeout(commitTimer);
      DM.restoreTopic(id);
      AE.refreshAll();Sched.build();renderMaterie();
    });
  }
  function openMove(id){
    _moveTId=id; const t=DM.getTopic(id);
    $('fMSubj').innerHTML=DM.getSubjects().map(s=>'<option value="'+s.id+'" '+(s.id===t.subjectId?'selected':'')+'>'+s.nome+'</option>').join('');
    const fill=sid=>{$('fMParent').innerHTML='<option value="">â€” Nessuno â€”</option>'+DM.getAllTopics().filter(tp=>tp.subjectId===sid&&!tp.del&&tp.id!==id).map(tp=>'<option value="'+tp.id+'">'+tp.titolo+'</option>').join('');};
    fill(t.subjectId); $('fMSubj').onchange=()=>fill($('fMSubj').value); openOv('ovMove');
  }
  function doMove(){
    const newParentId=$('fMParent').value||null;
    const oldTopic=DM.getTopic(_moveTId);
    // Vecchio padre: se torna foglia, rigenera il suo piano
    if(oldTopic.parentId){
      const oldSiblings=DM.getChildren(oldTopic.parentId).filter(c=>c.id!==_moveTId);
      if(oldSiblings.length===0){
        const op=DM.getTopic(oldTopic.parentId);
        if(op){ Sched.initTopic(op.id); }
      }
    }
    DM.updateTopic(_moveTId,{subjectId:$('fMSubj').value,parentId:newParentId});
    // Nuovo padre: non Ã¨ piÃ¹ foglia
    if(newParentId) DM.updateTopic(newParentId,{nextRev:null,intervalloCorrente:0,reviewPlan:[]});
    AE.refreshAll();Sched.build();closeOv('ovMove');renderMaterie();toast('Argomento spostato.');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDIA / TIMER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderStudia(){
    $('studiaSelect').style.display='block';$('studiaTimer').style.display='none';$('studiaDone').style.display='none';
    const activeSubjIds=new Set(DM.getSubjects().map(s=>s.id));
    const topics=DM.getAllTopics().filter(t=>activeSubjIds.has(t.subjectId));
    if(!topics.length){$('studiaList').innerHTML='';$('studiaEmpty').style.display='block';return;}
    $('studiaEmpty').style.display='none';
    const td=DM.todayStr(); let html='';
    DM.getSubjects().forEach(sub=>{
      // Mostra SOLO argomenti foglia (senza figli) â€” i non-foglia si
      // studiano attraverso i loro sotto-argomenti
      const st=topics.filter(t=>t.subjectId===sub.id&&DM.getChildren(t.id).length===0).sort((a,b)=>(b.prioritaCalcolata||0)-(a.prioritaCalcolata||0));
      if(!st.length) return;
      html+='<div style="margin-bottom:20px;">'+
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;">'+
        '<div class="dot" style="background:'+sub.colore+';width:9px;height:9px;"></div>'+
        '<span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink2);">'+sub.nome+'</span>'+
        (sub.dataEsame?'<span style="font-size:11px;color:var(--ink3);">Â· esame tra '+DM.daysUntil(sub.dataEsame)+' gg</span>':'')+
        '</div>';
      st.forEach(t=>{
        const isRev=DM.getRevsByDate(td).some(r=>r.topicId===t.id&&!r.done);
        const isNew=!t.numeroRipassi;
        const stab_=_topicStability(t);
        const prio_=_topicPriority(t);
        const barCol_=stab_>=70?'var(--green)':stab_>=35?'var(--amber)':'var(--red)';
        const prioDot_=prio_==='high'?'#DC2626':prio_==='medium'?'#D97706':'#16A34A';
        const planInfo_=(t.reviewPlan&&t.reviewPlan.length)?t.reviewPlan.length+' in piano':'';
        html+='<div class="row" style="cursor:pointer;" onclick="UI.startTimer(\''+t.id+'\')">'+
          '<div style="flex:1;min-width:0;">'+
          '<span style="font-size:13.5px;">'+t.titolo+'</span>'+
          '<div style="display:flex;align-items:center;gap:7px;margin-top:5px;">'+
          '<div title="PrioritÃ  '+(prio_==='high'?'Alta':prio_==='medium'?'Media':'Bassa')+'" style="width:7px;height:7px;border-radius:50%;background:'+prioDot_+';flex-shrink:0;"></div>'+
          '<div style="width:72px;height:3px;background:var(--line);border-radius:99px;overflow:hidden;flex-shrink:0;"><div style="height:100%;width:'+stab_+'%;background:'+barCol_+';border-radius:99px;"></div></div>'+
          '<div style="font-size:11px;color:var(--ink3);">'+
          (t.difficoltaPercepita?'diff '+t.difficoltaPercepita+'/10':'diff '+df(t.difficolta))+
          ' Â· '+(t.numeroRipassi||0)+' fatti'+
          (planInfo_?' Â· '+planInfo_:'')+
          (t.nextRev?' Â· prossimo '+t.nextRev:'')+
          '</div></div></div>'+
          (isRev?'<span class="badge b-amber">Ripasso oggi</span>':'')+
          (isNew?'<span class="badge b-def">Nuovo</span>':'')+
          (isRev?'<button class="snooze-btn" style="margin:4px 6px 0 0;" onclick="event.stopPropagation();UI.snoozeFromStudia(\''+t.id+'\')">&#128558;&#8205;&#128168; Non oggi</button>':'')+
          '<div class="row-act"><button class="btn btn-sm">Studia â†’</button></div></div>';
      });
      html+='</div>';
    });
    $('studiaList').innerHTML=html;
  }
  /* â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setTheme(t){
    document.documentElement.setAttribute('data-theme',t);
    DM.updatePrefs({theme:t});
    // Evidenzia pulsante attivo
    const bl=$('btnThemeLight'),bd=$('btnThemeDark');
    if(bl&&bd){
      bl.classList.toggle('btn-primary',t==='light');
      bl.classList.toggle('btn-ghost',t!=='light');
      bd.classList.toggle('btn-primary',t==='dark');
      bd.classList.toggle('btn-ghost',t!=='dark');
    }
  }
  function _applyTheme(){
    const t=DM.getPrefs().theme||'light';
    document.documentElement.setAttribute('data-theme',t);
  }

  /* â”€â”€ TIMER â€” CONFIGURAZIONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setTimerMode(mode, el){
    TS.mode=mode;
    document.querySelectorAll('.timer-mode-tab').forEach(t=>t.classList.remove('active'));
    if(el) el.classList.add('active');
    $('timerCountdownArea').style.display=mode==='countdown'?'':'none';
    $('timerFreeArea').style.display=mode==='free'?'':'none';
    _updateCfgSummary();
  }

  function adjCfg(field, delta){
    if(field==='study'){TS.study=Math.max(5,Math.min(180,TS.study+delta));$('cfgStudy').textContent=TS.study;}
    else if(field==='break'){TS.brk=Math.max(0,Math.min(60,TS.brk+delta));$('cfgBreak').textContent=TS.brk;}
    else if(field==='sessions'){TS.totalSessions=Math.max(1,Math.min(8,TS.totalSessions+delta));$('cfgSessions').textContent=TS.totalSessions;}
    _updateCfgSummary();
  }

  function _renderSessInfo(){
    const el=$('timerSessInfo'); if(!el) return;
    el.innerHTML='';
    for(let i=0;i<TS.totalSessions;i++){
      const b=document.createElement('span');
      b.className='timer-sess-badge'+(i===TS.sessionIdx?' active':'');
      b.textContent=(i+1);
      el.appendChild(b);
    }
  }

  function _renderPresets(){
    const prEl=$('timerPresets'); if(!prEl) return;
    const prefs=DM.getPrefs();
    const builtins=[
      {name:'Pomodoro',study:25,brk:5,sessions:4},
      {name:'Studio lungo',study:60,brk:10,sessions:2},
      {name:'Ripasso breve',study:15,brk:5,sessions:1},
    ];
    const custom=prefs.timerPresets||[];
    const all=[...builtins,...custom];
    prEl.innerHTML=all.map((p,i)=>'<button class="timer-preset-btn" onclick="UI.applyPreset('+i+')">'+p.name+'<br><span style="font-size:10px;opacity:.7;">'+p.study+'min Ã— '+p.sessions+'</span></button>').join('');
    // Aggiorna lista preset in impostazioni
    const pl=$('presetList'); if(!pl) return;
    pl.innerHTML=custom.length?custom.map((p,i)=>
      '<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--line);">'+
      '<span style="flex:1;font-size:12.5px;">'+p.name+' â€” '+p.study+'min studio Â· '+p.brk+'min pausa Â· '+p.sessions+' sess.</span>'+
      '<button class="btn btn-xs btn-ghost" style="color:var(--red);" onclick="UI.delPreset('+i+')">âœ•</button></div>'
    ).join(''):'<div style="font-size:12px;color:var(--ink3);">Nessun preset personalizzato.</div>';
  }

  function applyPreset(idx){
    const prefs=DM.getPrefs();
    const builtins=[
      {name:'Pomodoro',study:25,brk:5,sessions:4},
      {name:'Studio lungo',study:60,brk:10,sessions:2},
      {name:'Ripasso breve',study:15,brk:5,sessions:1},
    ];
    const all=[...builtins,...(prefs.timerPresets||[])];
    const p=all[idx]; if(!p) return;
    TS.study=p.study; TS.brk=p.brk; TS.totalSessions=p.sessions;
    if($('cfgStudy')) $('cfgStudy').textContent=TS.study;
    if($('cfgBreak'))  $('cfgBreak').textContent=TS.brk;
    if($('cfgSessions')) $('cfgSessions').textContent=TS.totalSessions;
    _renderSessInfo();
    // Evidenzia preset attivo
    document.querySelectorAll('#timerPresets .timer-preset-btn').forEach((b,i)=>b.classList.toggle('active',i===idx));
  }

  function addPreset(){
    const name=($('iPresetName').value||'').trim();
    const study=parseInt($('iPresetStudy').value)||25;
    const brk=parseInt($('iPresetBreak').value)||5;
    const sessions=parseInt($('iPresetSess').value)||1;
    if(!name){toast('Inserisci un nome per il preset.');return;}
    const prefs=DM.getPrefs();
    const presets=[...(prefs.timerPresets||[]),{name,study,brk,sessions}];
    DM.updatePrefs({timerPresets:presets});
    $('iPresetName').value='';
    _renderPresets();
    toast('Preset "'+name+'" aggiunto.');
  }

  function delPreset(idx){
    const prefs=DM.getPrefs();
    const presets=[...(prefs.timerPresets||[])];
    presets.splice(idx,1);
    DM.updatePrefs({timerPresets:presets});
    _renderPresets();
    toast('Preset eliminato.');
  }

  /* â”€â”€ TIMER â€” AVVIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* startTimer â€” mostra la schermata di configurazione SENZA avviare */
  function startTimer(tid){
    TS.topicId=tid;
    const t=DM.getTopic(tid), s=DM.getSubject(t?.subjectId);

    // Mostra timer, nascondi select e done
    $('studiaSelect').style.display='none';
    $('studiaTimer').style.display='block';
    $('studiaDone').style.display='none';

    // Mostra SOLO la config, nascondi running
    $('timerConfig').style.display='block';
    $('timerRunning').style.display='none';

    // Nomi argomento
    $('tSubj').textContent=s?.nome||'';
    $('tTopic').textContent=t?.titolo||'';
    $('tTopicSm').textContent=t?.titolo||'';

    // Carica ultima configurazione salvata
    const lastCfg=DM.getPrefs().lastTimerCfg||{};
    TS.study=lastCfg.study||DM.getPrefs().dur||25;
    TS.brk=lastCfg.brk||5;
    TS.totalSessions=lastCfg.sessions||1;
    TS.mode=lastCfg.mode||'countdown';

    // Popola i campi
    if($('cfgStudy'))    $('cfgStudy').textContent=TS.study;
    if($('cfgBreak'))    $('cfgBreak').textContent=TS.brk;
    if($('cfgSessions')) $('cfgSessions').textContent=TS.totalSessions;

    // UI modalitÃ 
    document.querySelectorAll('.timer-mode-tab').forEach(b=>b.classList.remove('active'));
    const activeTab=$(TS.mode==='free'?'tabFree':'tabCountdown');
    if(activeTab) activeTab.classList.add('active');
    $('timerCountdownArea').style.display=TS.mode==='free'?'none':'';
    $('timerFreeArea').style.display=TS.mode==='free'?'':'none';

    _renderPresets();
    _updateCfgSummary();
  }

  /* _updateCfgSummary â€” mostra un riepilogo leggibile sotto la config */
  function _updateCfgSummary(){
    const el=$('cfgSummary'); if(!el) return;
    if(TS.mode==='countdown'){
      const totStudy=TS.study*TS.totalSessions;
      const totBreak=TS.brk*(TS.totalSessions-1);
      const totMin=totStudy+totBreak;
      el.textContent=TS.totalSessions+' sess. Ã— '+TS.study+' min'+(TS.brk>0?' + '+TS.brk+' min pausa':'')+
        ' = '+totMin+' min totali';
    } else {
      el.textContent='Timer libero â€” nessun limite di tempo';
    }
  }

  /* timerAbort â€” torna alla lista argomenti senza avviare */
  function timerAbort(){
    clearInterval(TS.iv);
    $('studiaTimer').style.display='none';
    $('studiaSelect').style.display='block';
    $('studiaDone').style.display='none';
  }

  /* timerStart â€” avvia effettivamente il timer dopo la configurazione */
  function timerStart(){
    // Passa da config a running
    $('timerConfig').style.display='none';
    $('timerRunning').style.display='block';

    // Aggiorna nomi nella schermata running
    const t=DM.getTopic(TS.topicId), s=DM.getSubject(t?.subjectId);
    if($('tSubjR')) $('tSubjR').textContent=s?.nome||'';
    if($('tTopicR')) $('tTopicR').textContent=t?.titolo||'';

    // Mostra ring o free display
    const isCountdown=TS.mode!=='free';
    if($('timerRunCountdown')) $('timerRunCountdown').style.display=isCountdown?'':'none';
    if($('timerRunFree'))      $('timerRunFree').style.display=isCountdown?'none':'';

    // Avvia conteggio
    TS.sessionIdx=0; TS.phase='study'; TS.freeElapsed=0; TS.studyMinsAccum=0;
    TS.start=Date.now(); TS.running=true;
    _renderSessInfo();
    clearInterval(TS.iv);
    if(TS.mode==='free') _startFreeTimer();
    else _startCountdown();
  }

  function _startCountdown(){
    TS.total=TS.study*60; TS.secs=TS.total;
    _updateTimer();
    TS.iv=setInterval(()=>{
      if(!TS.running) return;
      TS.secs--;
      if(TS.secs<=0){
        TS.secs=0; _updateTimer();
        _onPhaseEnd();
      } else _updateTimer();
    },1000);
  }

  function _startFreeTimer(){
    TS.freeElapsed=0;
    if($('tFreeDisp')) $('tFreeDisp').textContent='00:00';
    TS.iv=setInterval(()=>{
      if(!TS.running) return;
      TS.freeElapsed++;
      const m=String(Math.floor(TS.freeElapsed/60)).padStart(2,'0');
      const s=String(TS.freeElapsed%60).padStart(2,'0');
      if($('tFreeDisp')) $('tFreeDisp').textContent=m+':'+s;
    },1000);
  }

  function _onPhaseEnd(){
    clearInterval(TS.iv);
    if(TS.phase==='study'){
      TS.studyMinsAccum+=TS.study;
      if(TS.brk>0 && TS.sessionIdx<TS.totalSessions-1){
        // Passa a pausa
        TS.phase='break';
        if($('timerPhaseLabel')) $('timerPhaseLabel').textContent='â˜• Pausa â€” riprenderai tra '+TS.brk+' minuti';
        TS.total=TS.brk*60; TS.secs=TS.total;
        _updateTimer();
        TS.iv=setInterval(()=>{
          if(!TS.running) return;
          TS.secs--;
          if(TS.secs<=0){ TS.secs=0; _updateTimer(); _onPhaseEnd(); }
          else _updateTimer();
        },1000);
        toast('Sessione '+(TS.sessionIdx+1)+' completata! Pausa di '+TS.brk+' min.');
        return;
      }
    }
    // Era pausa o nessuna pausa â†’ prossima sessione studio
    if(TS.phase==='break'){
      TS.sessionIdx++;
      TS.phase='study';
      if($('timerPhaseLabel')) $('timerPhaseLabel').textContent='';
      if(TS.sessionIdx<TS.totalSessions){
        _renderSessInfo();
        TS.total=TS.study*60; TS.secs=TS.total;
        _updateTimer();
        TS.iv=setInterval(()=>{
          if(!TS.running) return;
          TS.secs--;
          if(TS.secs<=0){ TS.secs=0; _updateTimer(); _onPhaseEnd(); }
          else _updateTimer();
        },1000);
        toast('Pausa finita! Sessione '+(TS.sessionIdx+1)+' iniziata.');
        return;
      }
    } else {
      TS.sessionIdx++;
    }
    // Tutte le sessioni completate
    if(TS.sessionIdx>=TS.totalSessions) timerEnd();
  }

  function _updateTimer(){
    const m=String(Math.floor(TS.secs/60)).padStart(2,'0'),s=String(TS.secs%60).padStart(2,'0');
    if($('tDisp')) $('tDisp').textContent=m+':'+s;
    const C=2*Math.PI*80;
    if($('tArc')) $('tArc').style.strokeDashoffset=C*(1-(TS.total>0?TS.secs/TS.total:0));
    // Cambio colore arco: verde studio, ambra pausa
    if($('tArc')) $('tArc').style.stroke=TS.phase==='break'?'var(--amber)':'var(--ink)';
    // Phase label countdown
    const lbl=$('timerPhaseLabel');
    if(lbl&&TS.phase==='study'&&TS.totalSessions>1){
      lbl.textContent='Sessione '+(TS.sessionIdx+1)+' di '+TS.totalSessions;
    }
    _renderSessInfo();
  }

  function timerPause(){
    TS.running=!TS.running;
    if($('tPauseBtn')) $('tPauseBtn').textContent=TS.running?'Pausa':'Riprendi';
  }
  function timerEnd(){
    clearInterval(TS.iv);TS.running=false;
    // Salva ultima configurazione
    DM.updatePrefs({lastTimerCfg:{study:TS.study,brk:TS.brk,sessions:TS.totalSessions,mode:TS.mode}});
    // Calcola durata effettiva in minuti
    let elapsed;
    if(TS.mode==='free'){
      elapsed=Math.round(TS.freeElapsed/60);
    } else {
      // Minuti delle fasi studio completate + frazione corrente se era in fase studio
      const completedStudy=TS.studyMinsAccum;
      const currentStudy=TS.phase==='study'?Math.round((TS.total-TS.secs)/60):0;
      elapsed=completedStudy+currentStudy;
    }
    elapsed=Math.max(1,elapsed);
    const t=DM.getTopic(TS.topicId);
    const s=DM.getSubject(t?.subjectId);
    $('timerRunning').style.display='none';
    $('studiaTimer').style.display='none';$('studiaDone').style.display='block';
    $('dTopic').textContent=t?.titolo||'';
    $('dDur').textContent='Durata: '+elapsed+' minut'+(elapsed===1?'o':'i');
    // Mostra info pre-esame se disponibile
    const dte=s&&s.dataEsame?DM.daysUntil(s.dataEsame):null;
    $('dExamInfo').textContent=dte!==null?'Esame tra '+dte+' giorni':'';
    // Default diff = precedente difficoltÃ  percepita o 5
    TS.diff = t?.difficoltaPercepita || 5;
    _renderDiffGrid();
  }
  function _renderDiffGrid(){
    const g=$('diffGrid');g.innerHTML='';
    for(let i=1;i<=10;i++){
      const col=i<=3?'#16A34A':i<=6?'#D97706':'#DC2626';
      const b=document.createElement('button');
      b.className='diff-btn'+(i===TS.diff?' sel':'');
      b.textContent=i;
      b.style.color=i===TS.diff?'#fff':col;
      if(i===TS.diff) b.style.background=col;
      b.style.borderColor=col;
      b.onclick=(function(val,colVal){
        return function(){
          TS.diff=val;
          g.querySelectorAll('.diff-btn').forEach(function(x){
            const v=parseInt(x.textContent);
            const c2=v<=3?'#16A34A':v<=6?'#D97706':'#DC2626';
            x.classList.remove('sel');x.style.background='';x.style.color=c2;x.style.borderColor=c2;
          });
          b.classList.add('sel');b.style.background=colVal;b.style.color='#fff';
          _previewPlan(val, TS.topicId);
        };
      })(i,col);
      g.appendChild(b);
    }
    _previewPlan(TS.diff, TS.topicId);
  }
  function _previewPlan(diff10, topicId){
    const el=$('dPlanPreview'); if(!el) return;
    const t=DM.getTopic(topicId); if(!t){el.textContent='';return;}
    const s=DM.getSubject(t.subjectId);
    const done=(t.numeroRipassi||0)+1;
    const plan=AE.generatePlan(diff10, s?s.dataEsame:null, DM.todayStr(), done);
    if(!plan.length){
      el.innerHTML='<strong>Nessun ripasso futuro.</strong> Esame troppo vicino o argomento giÃ  consolidato.';
      return;
    }
    const today=DM.todayStr();
    const colHead=diff10<=3?'#16A34A':diff10<=6?'#D97706':'#DC2626';
    const chips=plan.map(function(d,i){
      const days=Math.round((new Date(d+'T00:00:00')-new Date(today+'T00:00:00'))/86400000);
      const bg=diff10<=3?'#dcfce7':diff10<=6?'#fef3c7':'#fee2e2';
      const tc=diff10<=3?'#15803d':diff10<=6?'#b45309':'#b91c1c';
      return '<span class="plan-date-chip" style="background:'+bg+';color:'+tc+';">'+(i+1)+'. '+d+' <span style="opacity:.7;">(+'+days+'gg)</span></span>';
    }).join('');
    el.innerHTML='<strong style="color:'+colHead+';">'+plan.length+' ripasso'+(plan.length!==1?'i':'')+' pianificat'+(plan.length!==1?'i':'o')+'</strong> â€” difficoltÃ  <strong>'+diff10+'/10</strong><div class="plan-date-row">'+chips+'</div>';
  }
  function timerConfirm(){
    const t=DM.getTopic(TS.topicId);if(!t)return;
    const elapsed=Math.round((Date.now()-TS.start)/60000);
    DM.addSession({idArgomento:t.id,durataEffettiva:elapsed,difficolta:TS.diff});
    // AE.applySession genera il piano completo e aggiorna DB.reviews
    const result=AE.applySession(TS.topicId,TS.diff);
    // Marca come done la review di oggi se esisteva
    const rev=DM.getRevsByDate(DM.todayStr()).find(r=>r.topicId===t.id&&!r.done);
    if(rev) DM.markRevDone(rev.id);
    // Ricostruisce il calendario rispettando il nuovo piano
    Sched.build();
    const plan=result.plan||[];
    let msg;
    if(!plan.length){
      msg='Ottimo! Argomento consolidato. Nessun ripasso futuro necessario.';
    } else {
      const nextDate=plan[0];
      const diffDays=Math.round((new Date(nextDate+'T00:00:00')-new Date(DM.todayStr()+'T00:00:00'))/86400000);
      msg='Salvato. Piano: '+plan.length+' ripasso'+(plan.length!==1?'i':'')+' futur'+(plan.length!==1?'i':'o')+'. Prossimo tra '+diffDays+' giorn'+(diffDays===1?'o':'i')+' ('+nextDate+').';
    }
    toast(msg);
    $('studiaDone').style.display='none';$('studiaSelect').style.display='block';renderStudia();
    if(curPage==='classifica') renderClassifica();
  }

  /* snoozeReview / snoozeFromStudia */
  function snoozeReview(reviewId, topicId) {
    var result = AE.snoozeIntelligent(topicId);
    if (!result) { toast("Nessun ripasso oggi per questo argomento."); return; }
    Sched.build();
    if (result.warning) {
      var warn = document.createElement("div");
      warn.className = "snooze-warn";
      warn.textContent = result.warning;
      var pop = $("dpopBody");
      if (pop && pop.firstChild) pop.insertBefore(warn, pop.firstChild);
      setTimeout(function(){ if(warn.parentNode) warn.parentNode.removeChild(warn); }, 6000);
    }
    var nd = result.newDate;
    var diff = Math.round((new Date(nd+"T00:00:00") - new Date(DM.todayStr()+"T00:00:00")) / 86400000);
    toast("Spostato a " + nd + " (" + (diff===1?"domani":"tra "+diff+" giorni") + ").");
    $("dpop").classList.remove("open");
    setTimeout(function(){ openDayPop(DM.todayStr()); }, 180);
    if (curPage === "home") renderHome();
  }
  function snoozeFromStudia(topicId) {
    var result = AE.snoozeIntelligent(topicId);
    if (!result) { toast("Nessun ripasso da spostare oggi."); return; }
    Sched.build();
    if (result.warning) toast(result.warning);
    else toast("Rimandato a " + result.newDate + ".");
    renderStudia();
    if (curPage === "home") renderHome();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CALENDARIO â€” 4 viste
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const DAY_S=['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];


  function _bindCalCells(){
    const body=$('calBody');
    if(!body) return;
    body.onclick=function(e){
      const cell=e.target.closest('[data-date]');
      if(cell) openDayPop(cell.dataset.date);
    };
  }
  function setCalTab(mode,el){calMode=mode;document.querySelectorAll('.cal-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderCal();}
  function calMove(dir){
    if(calMode==='month')     calDate.setMonth(calDate.getMonth()+dir);
    else if(calMode==='week') calDate.setDate(calDate.getDate()+7*dir);
    else if(calMode==='3day') calDate.setDate(calDate.getDate()+3*dir);
    else                       calDate.setDate(calDate.getDate()+dir);
    renderCal();
  }
  function renderCal(){
    if(calMode==='month')      _calMonth();
    else if(calMode==='week')  _calWeek();
    else if(calMode==='3day')  _calNDay(3);
    else                        _calNDay(1);
  }

  function _topicPath(tid){const path=[];let t=DM.getTopic(tid);while(t){path.unshift(t);t=t.parentId?DM.getTopic(t.parentId):null;}return path;}
  function _buildDayData(ds){
    const revs=DM.getRevsByDate(ds), maxS=DM.getPrefs().maxSubjDay||3;
    const subIds=[...new Set(revs.map(r=>r.subjectId))].slice(0,maxS);
    return subIds.map(sid=>{
      const sub=DM.getSubject(sid);
      const sRevs=revs.filter(r=>r.subjectId===sid);
      return{sub,topics:sRevs.map(r=>({review:r,path:_topicPath(r.topicId)}))};
    });
  }

  /*
   * _cellHTML â€” cella nella vista mensile/settimanale.
   * Mostra solo un sommario sintetico: dot colorati per materia + dicitura "X materie Â· Y argomenti".
   * Il dettaglio completo appare solo al click (openDayPop).
   */
  function _cellHTML(date){
    const ds=date.toISOString().slice(0,10);
    const isToday=ds===DM.todayStr();
    const revs=DM.getRevsByDate(ds);
    const totRevs=revs.length;
    // Usiamo data-date + delegazione eventi invece di onclick inline
    // per evitare problemi di escaping delle virgolette
    let h='<div class="cal-cell'+(isToday?' today':'')+'" data-date="'+ds+'">';
    h+='<div class="cal-date-row">'+
       '<div class="cal-dn'+(isToday?' today':'')+'">'+date.getDate()+'</div>';
    if(totRevs){
      const ld=AE.calcDayLoad(revs);
      const col=ld<0.3?'var(--green)':ld<0.65?'var(--amber)':'var(--red)';
      h+='<div class="cal-load-dot" style="background:'+col+';" title="Carico '+Math.round(ld*100)+'%"></div>';
    }
    h+='</div>';
    if(totRevs){
      const subIds=[...new Set(revs.map(r=>r.subjectId))];
      const nSub=subIds.length;
      const nTop=totRevs;
      const dots=subIds.slice(0,6).map(function(sid){
        const sub=DM.getSubject(sid);
        return '<div class="cal-summary-dot" style="background:'+(sub?sub.colore:'#999')+';"></div>';
      }).join('');
      const subTxt=nSub===1?'1 materia':nSub+' materie';
      const topTxt=nTop===1?'1 argomento':nTop+' argomenti';
      const label=nSub===1&&nTop===1?subTxt:subTxt+' \u00b7 '+topTxt;
      const dayMins=Stats.minsOnDay(ds);
      const oreLabel=dayMins>0?' \u00b7 '+Stats.fmtOre(dayMins):'';
      h+='<div class="cal-summary">'+'<div class="cal-summary-dots">'+dots+'</div>'+'<div class="cal-summary-label">'+label+oreLabel+'</div>'+'</div>';
    }

    // Esami in questo giorno
    DM.getSubjects().forEach(function(sub){
      if (sub.dataEsame === ds) {
        h += '<div class="exam-cell">'
           + '<span class="exam-cell-label">ESAME</span>'
           + '<span class="exam-cell-name" style="color:'+sub.colore+';">'+sub.nome+'</span>'
           + '</div>';
      }
    });
    h+='</div>';
    return h;
  }


  function _calMonth(){
    const y=calDate.getFullYear(),m=calDate.getMonth();
    $('calTitle').textContent=new Date(y,m,1).toLocaleDateString('it-IT',{month:'long',year:'numeric'});
    const fo=new Date(y,m,1).getDay(),offset=fo===0?6:fo-1,dim=new Date(y,m+1,0).getDate();
    let h='<div class="cal-grid"><div class="cal-col-hdrs" style="grid-template-columns:repeat(7,1fr);">';
    DAY_S.forEach(d=>h+='<div class="cal-col-h">'+d+'</div>');
    h+='</div><div class="cal-cells" style="grid-template-columns:repeat(7,1fr);">';
    for(let i=0;i<offset;i++) h+='<div class="cal-cell other-m"></div>';
    for(let i=1;i<=dim;i++)   h+=_cellHTML(new Date(y,m,i));
    h+='</div></div>';
    $('calBody').innerHTML=h;
    _bindCalCells();
  }

  function _calWeek(){
    const start=new Date(calDate);
    const dow=start.getDay()===0?6:start.getDay()-1;start.setDate(start.getDate()-dow);
    const end=new Date(start);end.setDate(end.getDate()+6);
    $('calTitle').textContent=start.toLocaleDateString('it-IT',{day:'numeric',month:'short'})+' \u2013 '+end.toLocaleDateString('it-IT',{day:'numeric',month:'short',year:'numeric'});
    let h='<div class="cal-grid"><div class="cal-col-hdrs" style="grid-template-columns:repeat(7,1fr);">';
    DAY_S.forEach(d=>h+='<div class="cal-col-h">'+d+'</div>');
    h+='</div><div class="cal-cells" style="grid-template-columns:repeat(7,1fr);">';
    for(let i=0;i<7;i++){const d=new Date(start);d.setDate(d.getDate()+i);h+=_cellHTML(d);}
    h+='</div></div>';
    $('calBody').innerHTML=h;
    _bindCalCells();
  }

  function _scardHTML(sub,topics){
    const bg=ha(sub.colore||'#888',0.07), col=sub.colore||'#D97706';
    const scardMins=topics.reduce(function(a,item2){return a+(DM.getSessions().filter(function(s){return s.idArgomento===item2.review.topicId&&s.data===DM.todayStr();}).reduce(function(a2,s){return a2+(s.durataEffettiva||0);},0));},0);
    let h='<div class="scard" style="border-color:'+ha(col,0.3)+';">'+
      '<div class="scard-h" style="background:'+bg+';">'+
      '<div style="width:3px;height:14px;border-radius:99px;background:'+col+';flex-shrink:0;"></div>'+
      '<div class="scard-s" style="color:'+col+';">'+sub.nome+'</div>'+
      '<div class="scard-meta">'+topics.length+' argomento'+(topics.length!==1?'i':'')+'</div>'+
      '</div><div class="scard-body">';
    topics.forEach(({review,path})=>{
      const isDone=review.done;
      const leafNode=path[path.length-1];
      const leafTopic=DM.getTopic(review.topicId)||leafNode;
      const stab_c=_topicStability(leafTopic), prio_c=_topicPriority(leafTopic);
      const barCol_c=stab_c>=70?'var(--green)':stab_c>=35?'var(--amber)':'var(--red)';
      const prioDot_c=prio_c==='high'?'#DC2626':prio_c==='medium'?'#D97706':'#16A34A';
      path.forEach((node,i)=>{
        const ind=i===0?'Â·':i===1?'â†³':'  â†³';
        const lvl='l'+Math.min(2,i);
        const isLast=i===path.length-1;
        const meta=isLast?
          '<div style="display:flex;align-items:center;gap:5px;margin-top:3px;">'+
          '<div title="PrioritÃ  '+(prio_c==='high'?'Alta':prio_c==='medium'?'Media':'Bassa')+'" style="width:5px;height:5px;border-radius:50%;background:'+prioDot_c+';"></div>'+
          '<div style="width:48px;height:2px;background:var(--line);border-radius:99px;overflow:hidden;"><div style="height:100%;width:'+stab_c+'%;background:'+barCol_c+';border-radius:99px;"></div></div>'+
          (isDone?'<span style="color:var(--green);font-size:9px;">âœ“</span>':'')+
          '</div>':'';
        h+='<div class="scard-row'+(isDone?' scard-done':'')+'">'+
          '<span class="scard-ind">'+ind+'</span>'+
          '<div><span class="scard-tl '+lvl+'">'+node.titolo+'</span>'+meta+'</div>'+
          '</div>';
      });
    });
    h+='</div></div>'; return h;
  }

  function _calNDay(n){
    const days=[];
    for(let i=0;i<n;i++){const d=new Date(calDate);d.setDate(d.getDate()+i);days.push(d);}
    $('calTitle').textContent=n===1
      ?days[0].toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
      :days[0].toLocaleDateString('it-IT',{day:'numeric',month:'short'})+' \u2013 '+days[n-1].toLocaleDateString('it-IT',{day:'numeric',month:'short'});
    const cols='repeat('+n+',1fr)';
    let h='<div class="day-view" style="grid-template-rows:auto auto;grid-template-columns:'+cols+';">';
    days.forEach(d=>{
      const ds=d.toISOString().slice(0,10),isToday=ds===DM.todayStr(),dow=d.getDay()===0?6:d.getDay()-1;
      const colMins=Stats.minsOnDay(ds);
      h+='<div class="day-col-h"><div class="day-col-dl">'+DAY_S[dow]+'</div><div class="day-col-dn'+(isToday?' today':'')+'">'+d.getDate()+(colMins>0?'<div style="font-size:10px;color:var(--ink3);margin-top:1px;">'+Stats.fmtOre(colMins)+'</div>':'')+(DM.getSubjects().some(function(sub){return sub.dataEsame===ds;})?'<div style="margin-top:3px;font-size:9px;font-weight:700;color:#92400E;background:#FEF3C7;border-radius:3px;padding:1px 5px;display:inline-block;">ESAME '+(DM.getSubjects().find(function(sub){return sub.dataEsame===ds;})||{nome:''}).nome+'</div>':'')+'</div>';
    });
    days.forEach(d=>{
      const ds=d.toISOString().slice(0,10),data=_buildDayData(ds);
      h+='<div class="day-col-body">';
      if(!data.length) h+='<div style="font-size:12px;color:var(--ink3);padding-top:4px;">Nessun ripasso</div>';
      else data.forEach(({sub,topics})=>{if(sub)h+=_scardHTML(sub,topics);});
      h+='</div>';
    });
    h+='</div>';
    $('calBody').innerHTML=h;
    _bindCalCells();
  }

  /* Day detail popup â€” lista puntata + esame banner + snooze */
  function openDayPop(ds){
    var d=new Date(ds+'T00:00:00');
    $('dpopTitle').textContent=d.toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    var data=_buildDayData(ds);
    var pop=$('dpopBody');
    var today=DM.todayStr();
    var isToday=(ds===today);
    var h='';

    // Banner esami
    DM.getSubjects().forEach(function(sub){
      if(sub.dataEsame!==ds) return;
      var dte=DM.daysUntil(ds);
      var dteStr=dte===0?'Oggi!':dte>0?'Tra '+dte+' giorni':'Passato';
      h+='<div class="exam-banner">'
        +'<div class="exam-banner-icon">&#128197;</div>'
        +'<div class="exam-banner-body">'
        +'<div class="exam-banner-name">'+sub.nome+'</div>'
        +'<div class="exam-banner-meta">ESAME &middot; '+dteStr+(sub.cfu?' &middot; '+sub.cfu+' CFU':'')+'</div>'
        +'</div></div>';
    });

    var popTotMins=Stats.minsOnDay(ds);
    if(popTotMins>0){
      h+='<div style="margin-bottom:16px;padding:8px 12px;background:var(--paper2);border-radius:var(--r);display:flex;align-items:center;gap:10px;">'
        +'<span style="font-size:18px;">&#9201;</span>'
        +'<div><div style="font-size:13px;font-weight:500;">'+Stats.fmtOre(popTotMins)+' studiate</div>'
        +'<div style="font-size:11px;color:var(--ink3);">suddivisione sotto</div></div></div>';
    }

    if(!data.length && !h){
      pop.innerHTML='<p style="font-size:13px;color:var(--ink3);padding:8px 0;">Nessun ripasso pianificato.</p>';
      $('dpop').classList.add('open'); return;
    }

    data.forEach(function(item){
      var sub=item.sub, topics=item.topics;
      if(!sub) return;
      var col=sub.colore||'#D97706';
      var subTopicIds=new Set(DM.getTopics(sub.id).map(function(t){return t.id;}));
      var subMinsDay=DM.getSessions().filter(function(s){
        return s.data===ds && subTopicIds.has(s.idArgomento);
      }).reduce(function(a,s){return a+(s.durataEffettiva||0);},0);

      h+='<div style="margin-bottom:20px;">';
      h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">'
        +'<div style="width:3px;height:18px;border-radius:99px;background:'+col+';flex-shrink:0;"></div>'
        +'<span style="font-family:var(--serif);font-size:15px;color:'+col+';">'+sub.nome+'</span>'
        +(sub.dataEsame
          ?'<span class="badge b-def">'+(DM.daysUntil(sub.dataEsame)>=0?'Esame tra '+DM.daysUntil(sub.dataEsame)+' gg':'Passato')+'</span>'
          :'')
        +(subMinsDay>0?'<span style="margin-left:auto;font-size:11px;color:var(--ink3);">'+Stats.fmtOre(subMinsDay)+'</span>':'')
        +'</div>';

      h+='<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:7px;">';
      topics.forEach(function(item2){
        var review=item2.review, path=item2.path;
        var isDone=review.done;
        var leafNode=path[path.length-1];
        var leafT=DM.getTopic(review.topicId)||leafNode;
        var stab=_topicStability(leafT);
        var prio=_topicPriority(leafT);
        var barCol=stab>=70?'var(--green)':stab>=35?'var(--amber)':'var(--red)';
        var prioDot=prio==='high'?'#DC2626':prio==='medium'?'#D97706':'#16A34A';
        var prioLabel=prio==='high'?'Alta':prio==='medium'?'Media':'Bassa';
        var breadcrumb=path.map(function(n){return n.titolo;}).join(' &rsaquo; ');
        var planLeft=(leafT.reviewPlan&&leafT.reviewPlan.length)
          ?leafT.reviewPlan.length+' ripasso'+(leafT.reviewPlan.length!==1?'i':'')+' rimast'+(leafT.reviewPlan.length!==1?'i':'o')
          :'Piano completato';
        var topicTotMins=DM.getSessions().filter(function(s){return s.idArgomento===leafT.id;}).reduce(function(a,s){return a+(s.durataEffettiva||0);},0);
        var minsLbl=topicTotMins>0?Stats.fmtOre(topicTotMins)+' totali':'Nessuna sessione';
        var sc=review.snoozeCount||0;
        var snBadge=sc>0?'<span style="font-size:10px;color:var(--red);margin-left:4px;">rimandato '+sc+'&times;</span>':'';
        var snBtn=(!isDone&&isToday)
          ?'<button class="snooze-btn" onclick="UI.snoozeReview(\''+review.id+'\',\''+leafT.id+'\')">&#128558;&#8205;&#128168; Non riesco a farlo oggi</button>'
          :'';

        h+='<li style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:var(--r);background:var(--paper2);'
          +(isDone?'opacity:.5;':'')+'border:1px solid '+(sc>=3?'#FECACA':'transparent')+';">'
          +'<div style="width:7px;height:7px;border-radius:50%;background:'+col+';margin-top:4px;flex-shrink:0;"></div>'
          +'<div style="flex:1;min-width:0;">'
          +'<div style="font-size:13px;font-weight:500;">'+leafNode.titolo+snBadge
          +(isDone?' <span style="color:var(--green);font-size:11px;">&#10003;</span>':'')
          +'</div>'
          +(path.length>1?'<div style="font-size:11px;color:var(--ink3);margin-top:1px;">'+breadcrumb+'</div>':'')
          +'<div style="display:flex;align-items:center;gap:8px;margin-top:6px;">'
          +'<div style="width:7px;height:7px;border-radius:50%;background:'+prioDot+';flex-shrink:0;" title="Priorit&agrave; '+prioLabel+'"></div>'
          +'<div style="width:72px;height:3px;background:var(--line);border-radius:99px;overflow:hidden;">'
          +'<div style="height:100%;width:'+stab+'%;background:'+barCol+';border-radius:99px;"></div>'
          +'</div>'
          +'<span style="font-size:11px;color:var(--ink3);">'+minsLbl+' &middot; '+planLeft
          +(leafT.nextRev&&!isDone?' &middot; prossimo '+leafT.nextRev:'')
          +'</span>'
          +'</div>'+snBtn
          +'</div></li>';
      });
      h+='</ul></div>';
    });
    if(h) pop.innerHTML=h;
    $('dpop').classList.add('open');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIMULAZIONE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderSim(){
    const results=Sim.runAll();
    const el=$('simBody');
    if(!results.length){el.innerHTML='<div class="empty">Nessuna materia con data esame impostata.</div>';return;}
    const LEVEL_LABELS={low:'Rischio Basso',medium:'Rischio Medio',high:'Rischio Alto'};
    const LEVEL_DESC={
      low:'La maggior parte degli argomenti sarÃ  consolidata prima dell\'esame.',
      medium:'Alcuni argomenti potrebbero non consolidarsi in tempo. Aumenta la frequenza di studio.',
      high:'Rischio elevato di mancato consolidamento. Riduci gli intervalli e aumenta le sessioni quotidiane.'
    };
    let h='';
    results.forEach(({subject,risk,level,instabili,topicRisks,daysLeft})=>{
      h+='<div class="sim-card '+level+'" style="margin-bottom:16px;">'+
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">'+
        '<div class="dot" style="background:'+subject.colore+';width:10px;height:10px;"></div>'+
        '<div class="sim-risk-title">'+subject.nome+'</div>'+
        '<span class="badge b-def" style="margin-left:auto;">'+(daysLeft>=0?daysLeft+' giorni':'Passato')+'</span>'+
        '</div>'+
        '<div style="font-size:13px;color:var(--ink2);margin-bottom:12px;line-height:1.6;">'+
        '<strong>'+LEVEL_LABELS[level]+'</strong> ('+Math.round(risk*100)+'%) â€” '+LEVEL_DESC[level]+'<br>'+
        instabili+' argomento'+(instabili!==1?'i':'')+' ancora instabile'+(instabili!==1?'i':'')+'.</div>';
      // Topic risk detail
      h+='<div style="background:rgba(255,255,255,.5);border-radius:var(--r);padding:10px 14px;">';
      topicRisks.sort((a,b)=>b.riskScore-a.riskScore).forEach(({topic,riskScore,finalState,revsDone})=>{
        const col=riskScore<0.2?'var(--green)':riskScore<0.5?'var(--amber)':'var(--red)';
        h+='<div class="risk-row">'+
          '<div style="font-size:13px;flex:1;min-width:0;">'+topic.titolo+'</div>'+
          memB(finalState)+
          '<div style="font-size:11px;color:var(--ink3);min-width:60px;text-align:right;">'+(revsDone||0)+' sess.</div>'+
          '<div class="risk-bar"><div class="risk-fill" style="background:'+col+';width:'+Math.round(riskScore*100)+'%;"></div></div>'+
          '</div>';
      });
      h+='</div></div>';
    });
    el.innerHTML=h;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATISTICHE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderStats(){
    const prefs=DM.getPrefs();

    // â”€â”€ KPI strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const wMins   = Stats.weeklyMins();
    const mMins   = Stats.monthlyMins();
    $('stOre').textContent     = Stats.fmtOre(wMins);
    $('stOreMese').textContent = Stats.fmtOre(mMins);
    $('stStreak').textContent  = Stats.streak();
    $('stRev').textContent     = Stats.completedRev();

    // â”€â”€ Obiettivo settimanale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const goal      = (prefs.weeklyGoalMins || 600);
    const goalPct   = Math.min(100, Math.round(wMins / goal * 100));
    const goalRemMins = Math.max(0, goal - wMins);
    $('stGoalBar').style.width = goalPct + '%';
    $('stGoalBar').style.background = goalPct >= 100 ? 'var(--green)' : goalPct >= 60 ? 'var(--amber)' : 'var(--red)';
    $('stGoalLabel').textContent = goalPct + '% â€” ' + Stats.fmtOre(wMins) + ' / ' + Stats.fmtOre(goal);
    $('stGoalHint').textContent = goalPct >= 100
      ? 'ğŸ‰ Obiettivo raggiunto questa settimana!'
      : 'Mancano ' + Stats.fmtOre(goalRemMins) + ' per raggiungere l\u2019obiettivo.';

    // â”€â”€ Grafico 30 giorni â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const d30 = Stats.last30();
    const maxM30 = Math.max(...d30.map(d => d.mins), 1);
    const wrap30 = document.getElementById('chart30Wrap');
    wrap30.innerHTML = d30.map((d, i) => {
      const pct = Math.max(3, Math.round(d.mins / maxM30 * 100));
      const isToday = d.date === DM.todayStr();
      const col = isToday ? 'var(--ink)' : d.mins > 0 ? 'var(--amber)' : 'var(--paper3)';
      const title = d.date + (d.mins ? ': ' + Stats.fmtOre(d.mins) : ': nessuna sessione');
      return '<div title="' + title + '" style="flex:1;height:' + pct + '%;background:' + col + ';border-radius:2px 2px 0 0;min-height:3px;cursor:default;"></div>';
    }).join('');
    // Etichette: solo 1Â° di ogni settimana
    const lbWrap = document.getElementById('chart30Labels');
    const lbls = ['', '', '', '', '', '', ''];
    d30.forEach((d, i) => {
      const dd = new Date(d.date + 'T00:00:00');
      if (i === 0 || dd.getDay() === 1) lbls[i] = dd.getDate() + '/' + (dd.getMonth() + 1);
    });
    lbWrap.innerHTML = d30.map((d, i) => {
      const dd = new Date(d.date + 'T00:00:00');
      const showLbl = i === 0 || dd.getDay() === 1 || i === 29;
      return '<div style="flex:1;text-align:center;">' + (showLbl ? (dd.getDate() + '/' + (dd.getMonth() + 1)) : '') + '</div>';
    }).join('');

    // â”€â”€ Ore per materia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const mps = Stats.minsPerSubject();
    const maxMps = Math.max(...mps.map(x => x.mins), 1);
    const totalMinsAll = Stats.totalMins();
    document.getElementById('oreMaterie').innerHTML = mps.length
      ? mps.map(({ subject: s, mins, count }) => {
          const pct = Math.round(mins / maxMps * 100);
          const pctTot = totalMinsAll > 0 ? Math.round(mins / totalMinsAll * 100) : 0;
          // Avviso se materia non riceve tempo adeguato (< 10% del totale con esame imminente)
          const dte = s.dataEsame ? DM.daysUntil(s.dataEsame) : 9999;
          const warn = dte < 30 && pctTot < 10 && totalMinsAll > 60;
          return '<div style="margin-bottom:10px;">' +
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">' +
            '<div class="dot" style="background:' + s.colore + '"></div>' +
            '<div style="font-size:12.5px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + s.nome + '</div>' +
            (warn ? '<span title="Esame tra ' + dte + ' gg â€” dedica piÃ¹ tempo!" style="font-size:11px;color:var(--red);">âš  Poco tempo</span>' : '') +
            '<div style="font-size:11px;color:var(--ink3);min-width:80px;text-align:right;">' + Stats.fmtOre(mins) + ' (' + pctTot + '%)</div>' +
            '</div>' +
            '<div style="height:5px;background:var(--paper3);border-radius:99px;overflow:hidden;">' +
            '<div style="height:100%;width:' + pct + '%;background:' + s.colore + ';border-radius:99px;transition:width .5s;"></div>' +
            '</div></div>';
        }).join('')
      : '<div style="font-size:13px;color:var(--ink3);">Nessuna sessione registrata.</div>';

    // â”€â”€ Top argomenti per ore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tps = Stats.minsPerTopic(8);
    const maxTps = Math.max(...tps.map(x => x.mins), 1);
    document.getElementById('oreArgomenti').innerHTML = tps.length
      ? tps.map(({ topic: t, mins, count }) => {
          const sub = DM.getSubject(t.subjectId);
          const pct = Math.round(mins / maxTps * 100);
          return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">' +
            '<div class="dot" style="background:' + (sub ? sub.colore : '#aaa') + '"></div>' +
            '<div style="flex:1;min-width:0;">' +
            '<div style="font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + t.titolo + '</div>' +
            '<div style="height:3px;background:var(--paper3);border-radius:99px;overflow:hidden;margin-top:3px;">' +
            '<div style="height:100%;width:' + pct + '%;background:' + (sub ? sub.colore : '#aaa') + ';border-radius:99px;"></div>' +
            '</div></div>' +
            '<div style="font-size:11px;color:var(--ink3);min-width:60px;text-align:right;">' + Stats.fmtOre(mins) + '</div>' +
            '</div>';
        }).join('')
      : '<div style="font-size:13px;color:var(--ink3);">Nessuna sessione registrata.</div>';

    // â”€â”€ CFU dist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cfu = Stats.cfuDist();
    $('cfuChart').innerHTML = cfu.length ? cfu.map(({ subject: s, pct }) =>
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:9px;">' +
      '<div class="dot" style="background:' + s.colore + '"></div>' +
      '<div style="font-size:12.5px;min-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + s.nome + '</div>' +
      '<div style="flex:1;"><div class="prog"><div class="prog-bar" style="background:' + s.colore + ';width:' + pct + '%;"></div></div></div>' +
      '<div style="font-size:11px;color:var(--ink3);min-width:55px;text-align:right;">' + (s.cfu || '?') + ' CFU (' + pct + '%)</div></div>'
    ).join('') : '<div style="font-size:13px;color:var(--ink3);">Nessuna materia.</div>';

    // â”€â”€ Diff per materia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dps = Stats.diffPerSubj();
    $('diffChart').innerHTML = dps.length ? dps.map(({ subject: s, avg }) => {
      const col = avg > 3.5 ? 'var(--red)' : avg > 2.5 ? 'var(--amber)' : 'var(--green)';
      return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:9px;">' +
        '<div class="dot" style="background:' + s.colore + '"></div>' +
        '<div style="font-size:12.5px;min-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + s.nome + '</div>' +
        '<div style="flex:1;"><div class="prog"><div class="prog-bar" style="background:' + col + ';width:' + Math.round(avg / 5 * 100) + '%;"></div></div></div>' +
        '<div style="font-size:11px;font-weight:500;color:' + col + ';min-width:28px;text-align:right;">' + avg.toFixed(1) + '</div></div>';
    }).join('') : '<div style="font-size:13px;color:var(--ink3);">Nessuna materia.</div>';

    // â”€â”€ Sessioni recenti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const rs = Stats.recentSess();
    $('recentList').innerHTML = rs.length ? rs.map(s => {
      const t = DM.getTopic(s.idArgomento), sub = t ? DM.getSubject(t.subjectId) : null;
      return '<div class="row">' +
        '<div class="dot" style="background:' + (sub?.colore || '#aaa') + '"></div>' +
        '<div style="flex:1;min-width:0;"><div style="font-size:13.5px;">' + (t?.titolo || 'â€”') + '</div>' +
        '<div style="font-size:12px;color:var(--ink3);">' + (sub?.nome || '') + ' Â· ' + s.data + '</div></div>' +
        '<span class="badge b-def">diff ' + df(s.difficolta) + '</span>' +
        '<span style="font-size:12px;color:var(--ink3);min-width:44px;text-align:right;">' + Stats.fmtOre(s.durataEffettiva || 0) + '</span>' +
        '</div>';
    }).join('') : '<div class="empty">Nessuna sessione.</div>';
  }
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CLASSIFICA SETTIMANALE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  function setWkMode(mode, el) {
    _wkMode = mode;
    document.querySelectorAll('#page-classifica .cal-tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    renderClassifica();
  }

  /* Concludi settimana: snapshot â†’ weeklyLogs */
  function closeWeek() {
    const key = Stats.currentWeekKey();
    const logs = DM.getWeeklyLogs();
    if (logs.find(l => l.weekKey === key)) {
      toast('Settimana giÃ  conclusa.'); return;
    }
    const snap = Stats.weekSnapshot(key);
    if (snap.mins === 0) {
      toast('Nessuna ora registrata questa settimana.'); return;
    }
    DM.addWeeklyLog({ ...snap, closedAt: DM.todayStr() });
    toast('Settimana conclusa e salvata nel registro!');
    renderClassifica();
  }

  function renderClassifica() {
    const cmp    = Stats.weekComparison();
    const { curr, prev, diff } = cmp;
    const logs   = DM.getWeeklyLogs();
    const currKey= Stats.currentWeekKey();
    const isClosed = !!logs.find(l => l.weekKey === currKey);

    // â”€â”€ Pulsante chiudi / giÃ  chiusa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const btn = $('wkCloseBtn');
    if (btn) {
      btn.textContent = isClosed ? 'âœ“ Settimana conclusa' : 'âœ“ Concludi settimana';
      btn.disabled = isClosed;
      btn.style.opacity = isClosed ? '.45' : '1';
    }

    // â”€â”€ Barre confronto corrente vs precedente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const bars = $('wkCompareBars');
    if (bars) {
      const maxM = Math.max(curr.mins, prev ? prev.mins : 0, 1);

      const fmtWeek = wk => {
        const d = new Date(wk + 'T00:00:00');
        return d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }) + ' â€“ ' +
               new Date(d.getTime() + 6 * 86400000).toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
      };

      let html = '';

      if (_wkMode === 'ore') {
        // â”€â”€ Barra settimana corrente
        const pctC = Math.round(curr.mins / maxM * 100);
        html += '<div class="wk-compare-row">' +
          '<div class="wk-name">Questa sett.</div>' +
          '<div class="wk-bar-wrap"><div class="wk-bar" style="width:' + pctC + '%;background:var(--ink);"></div></div>' +
          '<div class="wk-label">' + Stats.fmtOre(curr.mins) + '</div></div>';
        if (prev) {
          const pctP = Math.round(prev.mins / maxM * 100);
          html += '<div class="wk-compare-row">' +
            '<div class="wk-name" style="color:var(--ink3);">Scorsa sett.</div>' +
            '<div class="wk-bar-wrap"><div class="wk-bar" style="width:' + pctP + '%;background:var(--paper3);border:1px solid var(--line);"></div></div>' +
            '<div class="wk-label">' + Stats.fmtOre(prev.mins) + '</div></div>';
        }
        // Barra obiettivo
        const goalPct = Math.min(100, Math.round(curr.mins / curr.goal * 100));
        const goalCol = goalPct >= 100 ? 'var(--green)' : goalPct >= 60 ? 'var(--amber)' : 'var(--red)';
        html += '<div style="margin-top:4px;display:flex;align-items:center;gap:8px;font-size:11px;color:var(--ink3);">' +
          '<span>Obiettivo ' + Stats.fmtOre(curr.goal) + '</span>' +
          '<div style="flex:1;height:3px;background:var(--paper3);border-radius:99px;overflow:hidden;">' +
          '<div style="height:100%;width:' + goalPct + '%;background:' + goalCol + ';border-radius:99px;"></div></div>' +
          '<span>' + goalPct + '%</span></div>';

      } else if (_wkMode === 'materia') {
        const byS = curr.bySubj;
        const maxS = Math.max(...byS.map(x => x.mins), 1);
        if (!byS.length) {
          html = '<div style="font-size:13px;color:var(--ink3);">Nessuna sessione questa settimana.</div>';
        } else {
          byS.forEach(({ subject: s, mins }) => {
            const pct = Math.round(mins / maxS * 100);
            html += '<div class="wk-compare-row">' +
              '<div class="dot" style="background:' + s.colore + ';flex-shrink:0;"></div>' +
              '<div class="wk-name">' + s.nome + '</div>' +
              '<div class="wk-bar-wrap"><div class="wk-bar" style="width:' + pct + '%;background:' + s.colore + ';"></div></div>' +
              '<div class="wk-label">' + Stats.fmtOre(mins) + '</div></div>';
          });
        }

      } else { // revs
        const rC = curr.revs, rP = prev ? prev.revs : 0;
        const maxR = Math.max(rC, rP, 1);
        html += '<div class="wk-compare-row">' +
          '<div class="wk-name">Questa sett.</div>' +
          '<div class="wk-bar-wrap"><div class="wk-bar" style="width:' + Math.round(rC / maxR * 100) + '%;background:var(--ink);"></div></div>' +
          '<div class="wk-label">' + rC + ' ripassi</div></div>';
        if (prev) {
          html += '<div class="wk-compare-row">' +
            '<div class="wk-name" style="color:var(--ink3);">Scorsa sett.</div>' +
            '<div class="wk-bar-wrap"><div class="wk-bar" style="width:' + Math.round(rP / maxR * 100) + '%;background:var(--paper3);border:1px solid var(--line);"></div></div>' +
            '<div class="wk-label">' + rP + ' ripassi</div></div>';
        }
      }
      bars.innerHTML = html;
    }

    // â”€â”€ Messaggio motivazionale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const motiv = Stats.motivMsg(cmp);
    const motivEl = $('wkMotiv');
    if (motivEl) {
      if (motiv) {
        motivEl.innerHTML = '<div class="wk-motiv-banner">' +
          '<div class="wk-motiv-icon">' + motiv.icon + '</div>' +
          '<div style="font-size:13px;color:' + motiv.color + ';">' + motiv.text + '</div>' +
          '</div>';
        motivEl.style.display = 'block';
      } else {
        motivEl.innerHTML = '<div style="font-size:13px;color:var(--ink3);">Inizia a studiare questa settimana per vedere il confronto.</div>';
      }
    }

    // â”€â”€ Podio top 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const top3 = Stats.topWeeks();
    const podioEl = $('wkPodio');
    if (podioEl) {
      if (!top3.length) {
        podioEl.innerHTML = '<div style="font-size:13px;color:var(--ink3);">Nessuna settimana registrata.</div>';
      } else {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const classes = ['gold', 'silver', 'bronze'];
        const fmtDate = wk => {
          const d = new Date(wk + 'T00:00:00');
          return d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' });
        };
        podioEl.innerHTML = top3.map((w, i) => {
          const isCurr = w.weekKey === currKey;
          const goalBadge = w.goalReached
            ? '<span class="podio-badge">â­ Obiettivo raggiunto</span>' : '';
          return '<div class="podio-item ' + (classes[i] || '') + '">' +
            '<div class="podio-rank">' + (medals[i] || (i + 1) + '.') + '</div>' +
            '<div class="podio-body">' +
            '<div class="podio-ore">' + Stats.fmtOre(w.mins) +
              (isCurr ? ' <span style="font-size:11px;font-weight:400;color:var(--ink3);">(in corso)</span>' : '') +
            '</div>' +
            '<div class="podio-date">Settimana del ' + fmtDate(w.weekKey) +
              (w.revs ? ' Â· ' + w.revs + ' ripassi' : '') + '</div>' +
            '</div>' + goalBadge + '</div>';
        }).join('');
      }
    }

    // â”€â”€ Storico completo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const logEl = $('wkLog');
    const logCount = $('wkLogCount');
    const allLogs = [...logs].sort((a, b) => b.weekKey.localeCompare(a.weekKey));
    if (logCount) logCount.textContent = allLogs.length + ' settiman' + (allLogs.length === 1 ? 'a' : 'e') + ' registrat' + (allLogs.length === 1 ? 'a' : 'e');
    if (logEl) {
      if (!allLogs.length) {
        logEl.innerHTML = '<div style="font-size:13px;color:var(--ink3);">Concludi la prima settimana per vederla qui.</div>';
      } else {
        logEl.innerHTML = allLogs.map((w, i) => {
          const prev2 = allLogs[i + 1];
          const delta = prev2 ? w.mins - prev2.mins : null;
          const deltaStr = delta === null ? '' :
            delta > 0 ? '<span style="color:var(--green);">â†‘ +' + Stats.fmtOre(delta) + '</span>' :
            delta < 0 ? '<span style="color:var(--red);">â†“ ' + Stats.fmtOre(delta) + '</span>' :
            '<span style="color:var(--ink3);">â†’ stabile</span>';
          const fmtD = wk => {
            const d = new Date(wk + 'T00:00:00');
            return d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
          };
          const { to } = Stats.weekRange(w.weekKey);
          return '<div class="wk-log-row">' +
            '<div style="font-size:12.5px;flex:1;">' +
              fmtD(w.weekKey) + ' â€“ ' + fmtD(to) +
              (w.goalReached ? ' <span style="color:var(--green);font-size:11px;">â­</span>' : '') +
            '</div>' +
            '<div class="wk-delta">' + deltaStr + '</div>' +
            '<div class="wk-label" style="font-family:var(--mono);font-size:12px;">' + Stats.fmtOre(w.mins) + '</div>' +
            '</div>';
        }).join('');
      }
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     IMPOSTAZIONI
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderImpost(){
    const p=DM.getPrefs();
    $('iPName').value=p.name||'';$('iPDur').value=p.dur||25;$('iPMax').value=p.maxSubjDay||3;$('iPGoal').value=Math.round((p.weeklyGoalMins||600)/60);
  }
  function savePrefs(){
    DM.updatePrefs({name:$('iPName').value.trim(),dur:parseInt($('iPDur').value)||25,maxSubjDay:parseInt($('iPMax').value)||3,weeklyGoalMins:(parseInt($('iPGoal').value)||10)*60});
    Sched.build();toast('Preferenze salvate.');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OVERLAYS / CONFIRM / TOAST
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function openOv(id){$(id).classList.add('open');}
  function closeOv(id){$(id).classList.remove('open');}
  function cfConfirm(title,body,cb){
    $('cfTitle').textContent=title;$('cfBody').textContent=body;_cfCb=cb;$('cfBox').classList.add('open');
  }
  function cfOk(){$('cfBox').classList.remove('open');if(_cfCb){_cfCb();_cfCb=null;}}
  function cfCancel(){$('cfBox').classList.remove('open');_cfCb=null;}
  function confirmReset(){cfConfirm('Reset completo','Tutti i dati verranno eliminati definitivamente. Questa azione Ã¨ irreversibile.',()=>{DM.reset();goto('home');toast('Tutti i dati eliminati.');});}

  function toast(msg,undoFn){
    const el=$('toast'); clearTimeout(_toastTm); clearTimeout(_undoTm);
    if(undoFn){
      el.innerHTML=msg+' <span class="toast-undo">Annulla</span>';
      el.querySelector('.toast-undo').onclick=()=>{undoFn();el.classList.remove('show');clearTimeout(_undoTm);};
      el.classList.add('show');_undoTm=setTimeout(()=>el.classList.remove('show'),5000);
    } else {
      el.innerHTML=msg;el.classList.add('show');_toastTm=setTimeout(()=>el.classList.remove('show'),3000);
    }
  }

  // Close overlays on outside click
  document.querySelectorAll('.ov').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));
  document.getElementById('dpop').addEventListener('click',e=>{if(e.target===document.getElementById('dpop'))document.getElementById('dpop').classList.remove('open');});
  document.getElementById('cfBox').addEventListener('click',e=>{if(e.target===document.getElementById('cfBox'))cfCancel();});

  return { toggleSidebar, goto, toggleBlock, _hToggleStudyItem, _hToggleExam, openAddSubj, editSubj, saveSubj, archSubj, openAddTopic, editTopic, saveTopic, delTopic, openMove, doMove, togAcc, startTimer, timerStart, timerAbort, timerPause, timerEnd, timerConfirm, setTimerMode, adjCfg, applyPreset, addPreset, delPreset, setCalTab, calMove, openDayPop, snoozeReview, snoozeFromStudia, cfOk, cfCancel, confirmReset, openOv, closeOv, savePrefs, setTheme, _applyTheme, toast, renderHome, renderMaterie, renderStudia, renderSim, renderStats, renderClassifica, closeWeek, setWkMode, renderImpost };
})();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” bootstrap sequenza
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function init() {
  AE.refreshAll();   // ricalcola stati memoria e prioritÃ 
  Sched.build();     // genera calendario
  UI.goto('home');   // avvia UI
})();
</script>
</body>
</html>
